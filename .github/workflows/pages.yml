name: pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: [ self-hosted, macOS ]     # Twój Mac (labels z ekranu Runners)
    timeout-minutes: 30

    env:
      SITE_URL:             ${{ vars.SITE_URL }}
      GA_ID:                ${{ vars.GA_ID }}
      GSC_VERIFICATION:     ${{ vars.GSC_VERIFICATION }}
      INDEXNOW_KEY:         ${{ vars.INDEXNOW_KEY }}
      BING_SITE_AUTH_USER:  ${{ vars.BING_SITE_AUTH_USER }}
      NEWS_ENABLED:         ${{ vars.NEWS_ENABLED }}
      BUILD_ID:             ${{ github.run_id }}
      BUILD_NUM:            ${{ github.run_number }}
      LOCAL_XLSX:           ${{ vars.LOCAL_XLSX }}   # absolutna ścieżka na Macu

    steps:
      # ---------- Przygotowanie macOS (Brew, PATH, narzędzia) ----------
      - name: Prepare macOS runner
        shell: bash
        run: |
          set -euo pipefail
          ARCH="$(uname -m)"   # arm64 lub x86_64

          # ustaw PATH i shellenv brew
          if [ -x /opt/homebrew/bin/brew ]; then
            BREW=/opt/homebrew/bin/brew
            eval "$($BREW shellenv)"
            export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$PATH"
          elif [ -x /usr/local/bin/brew ]; then
            BREW=/usr/local/bin/brew
            eval "$($BREW shellenv)"
            export PATH="/usr/local/bin:/usr/local/sbin:$PATH"
          else
            echo "::warning::Homebrew not found. Install if you need extra tools."
            BREW=""
          fi

          # podstawowe narzędzia – jeśli brew jest
          if [ -n "${BREW}" ]; then
            if [ "${ARCH}" = "arm64" ]; then
              arch -arm64 ${BREW} update || true
              arch -arm64 ${BREW} install gnu-tar gnu-sed coreutils zip tree git-lfs jq python@3 || true
            else
              ${BREW} update || true
              ${BREW} install gnu-tar gnu-sed coreutils zip tree git-lfs jq python@3 || true
            fi
            git lfs install || true
          fi

          echo "PATH=$PATH"
          which gtar || true
          which gsed || true
          which jq   || true
          python3 -V || true
          git --version || true

      # ---------- Checkout (bez LFS) ----------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: false

      - name: Show commit info
        shell: bash
        run: |
          set -euo pipefail
          echo "repo:  $GITHUB_REPOSITORY"
          echo "sha:   $GITHUB_SHA"
          echo "actor: $GITHUB_ACTOR"

      # ---------- (opcjonalnie) kopiuj XLSX z dysku ----------
      - name: Copy local XLSX if provided
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data
          if [ -n "${LOCAL_XLSX:-}" ] && [ -f "${LOCAL_XLSX}" ]; then
            echo "Using LOCAL_XLSX: ${LOCAL_XLSX}"
            cp -f "${LOCAL_XLSX}" data/cms.xlsx
          else
            echo "::notice::LOCAL_XLSX not set or file missing - expecting data/cms.xlsx in workspace."
          fi

      - name: Check XLSX presence
        shell: bash
        run: |
          set -euo pipefail
          test -f data/cms.xlsx && echo "cms.xlsx OK" || { echo "Missing data/cms.xlsx"; exit 1; }

      # ---------- Python ----------
      - name: Install Python deps
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m pip install openpyxl unidecode

      # ---------- Generuj NAV ----------
      - name: Generate static NAV from XLSX
        shell: bash
        run: |
          set -euo pipefail
          python3 tools/generate_nav_from_xlsx.py
          ls -lah assets/nav || true

      # (pomocniczy artefakt do debug)
      - name: Upload NAV bundles (artifact, debug)
        uses: actions/upload-artifact@v4
        with:
          name: nav-bundles
          path: assets/nav/*.json
          if-no-files-found: warn
          retention-days: 3

      # ---------- Sanity (Jinja) ----------
      - name: Sanity check (templates compile)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from jinja2 import Environment, FileSystemLoader
          env = Environment(loader=FileSystemLoader('templates'))
          env.get_template('base.html')
          env.get_template('page.html')
          print("Templates OK")
          PY

      # ---------- Build ----------
      - name: Build site (HTML + sitemaps/robots)
        shell: bash
        env:
          SITE_URL:             ${{ env.SITE_URL }}
          GA_ID:                ${{ env.GA_ID }}
          GSC_VERIFICATION:     ${{ env.GSC_VERIFICATION }}
          INDEXNOW_KEY:         ${{ env.INDEXNOW_KEY }}
          BING_SITE_AUTH_USER:  ${{ env.BING_SITE_AUTH_USER }}
          NEWS_ENABLED:         ${{ env.NEWS_ENABLED }}
        run: |
          set -euo pipefail
          python3 -u tools/build.py
          test -d dist || { echo "dist/ missing"; exit 1; }
          stat dist/index.html || { echo "index.html missing"; exit 1; }
          (command -v tree >/dev/null 2>&1 && tree -L 2 dist | sed -n '1,150p') || ls -la dist | head -n 200

      # ---------- Cache-bust ----------
      - name: Cache-bust static assets (CSS/JS) in built HTML
        shell: bash
        env:
          BUST: ${{ github.run_number }}-${{ github.run_id }}
        run: |
          set -euo pipefail
          ASSETS=("/assets/js/site.js" "/assets/js/cms.js" "/assets/css/site.css")
          for P in "${ASSETS[@]}"; do
            grep -RIl --include="*.html" -- "$P" dist | while read -r f; do
              if command -v gsed >/dev/null 2>&1; then
                gsed -i -E "s#(${P})(\\?[^\"']*)?([\"'])#\\1?v=${BUST}\\3#g" "$f"
              else
                sed -i '' -E "s#(${P})(\\?[^\"']*)?([\"'])#\\1?v=${BUST}\\3#g" "$f" || true
              fi
            done
          done
          echo "Preview (busted):"
          grep -R --include="*.html" -nE "/assets/(css|js)/(site|cms)\\.(css|js)\\?v=" dist | head -n 20 || true

      # ---------- ZIP (opcjonalnie) ----------
      - name: Make site snapshot (ZIP)
        shell: bash
        run: |
          set -euo pipefail
          (cd dist && zip -qr ../dist.zip .) || true
          ls -lh dist.zip || true

      # ---------- Upewnij się, że jest gtar ----------
      - name: Ensure GNU tar (gtar)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v gtar >/dev/null 2>&1; then
            echo "gtar not found – installing gnu-tar…"
            if command -v brew >/dev/null 2>&1; then
              ARCH="$(uname -m)"
              if [ "${ARCH}" = "arm64" ]; then
                arch -arm64 brew install gnu-tar
              else
                brew install gnu-tar
              fi
            else
              echo "::warning::brew not found – upload-pages-artifact może wymagać gtar"
            fi
          fi
          command -v gtar >/dev/null 2>&1 && gtar --version | head -1 || true

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist        # tylko 'path' – ta akcja nie przyjmuje `if-no-files-found`

  deploy:
    needs: build
    runs-on: [ self-hosted, macOS ]
    timeout-minutes: 15
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
