<style>
  /* =========================
     CSS: Maersk-like Mega Menu
     ========================= */
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;line-height:1.5}
  img,svg{display:block;max-width:100%}
  a{color:inherit;text-decoration:none}
  button{font:inherit}
  :focus-visible{outline:2px solid var(--focus);outline-offset:2px;border-radius:4px}

  :root{
    --brand:#00A3E0;--brand-ink:#003B57;
    --bg:#fff;--ink:#0f172a;--muted:#6b7280;
    --surface:color-mix(in srgb,var(--bg) 80%,transparent);
    --header-alpha:.65;--elev:16px;--radius:12px;--focus:#94caff;
    --shadow:0 10px 30px rgba(0,0,0,.08);
    --shadow-strong:0 10px 40px rgba(0,0,0,.16);
    --maxw:1200px;--nav-h:72px;--z-header:50;--z-panel:49;--z-drawer:60
  }
  @media (prefers-color-scheme: dark){
    :root{--bg:#0b1220;--ink:#e5e7eb;--muted:#a3a3a3;--surface:color-mix(in srgb,var(--bg) 65%,transparent);--header-alpha:.35;--focus:#52b6ff;--shadow:0 10px 30px rgba(0,0,0,.6);--shadow-strong:0 10px 40px rgba(0,0,0,.7)}
  }
  html[data-theme="light"]{color-scheme:light}
  html[data-theme="dark"]{color-scheme:dark}
  body{background:var(--bg);color:var(--ink)}
  .container{max-width:var(--maxw);margin-inline:auto;padding-inline:20px}

  .skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  .skip-link:focus{left:12px;top:12px;width:auto;height:auto;background:var(--bg);color:var(--ink);padding:.6rem .8rem;border-radius:8px;box-shadow:var(--shadow);z-index:999}

  .site-header{position:sticky;top:0;inset-inline:0;z-index:var(--z-header);backdrop-filter:saturate(1.2) blur(8px);background:color-mix(in srgb,var(--bg) calc(var(--header-alpha)*100%),transparent);transition:background .25s ease,box-shadow .25s ease,border-color .25s ease;border-bottom:1px solid color-mix(in srgb,var(--ink) 10%,transparent)}
  .site-header.is-scrolled{background:var(--bg);box-shadow:var(--shadow)}
  .navbar{display:flex;align-items:center;justify-content:space-between;height:var(--nav-h)}
  .brand{display:inline-flex;align-items:center;gap:.6rem;font-weight:800;letter-spacing:.2px}
  .brand__logo{width:36px;height:36px;border-radius:8px;background:var(--brand);display:grid;place-items:center;color:#fff;font-weight:900;box-shadow:var(--shadow)}
  .brand__name{font-size:1.1rem}

  .nav{display:flex;align-items:center;gap:24px}
  .nav__list{display:flex;align-items:center;gap:10px;margin:0;padding:0;list-style:none}
  .nav__btn{position:relative;display:inline-flex;align-items:center;gap:.35rem;padding:.6rem .8rem;border-radius:10px;border:none;background:transparent;color:inherit;cursor:pointer}
  .nav__btn .chev{inline-size:.85rem;block-size:.85rem;transition:transform .2s ease}
  .nav__btn[aria-expanded="true"] .chev{transform:rotate(180deg)}
  .nav__btn:hover{background:color-mix(in srgb,var(--brand) 10%,transparent)}
  .nav__btn[aria-current="page"]{font-weight:700}

  .actions{display:flex;align-items:center;gap:10px}
  .cta{display:inline-flex;align-items:center;gap:.5rem;border-radius:999px;padding:.55rem 1rem;background:var(--brand);color:#fff;font-weight:700;box-shadow:var(--shadow-strong)}
  .cta:hover{filter:brightness(.95)}
  .icon-btn{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:10px;border:1px solid color-mix(in srgb,var(--ink) 12%,transparent);background:transparent;cursor:pointer}
  .hamburger{display:none}
  .lang{position:relative}
  .lang__panel{position:absolute;right:0;top:calc(100% + 8px);background:var(--bg);border:1px solid color-mix(in srgb,var(--ink) 12%,transparent);border-radius:12px;box-shadow:var(--shadow);padding:8px;min-width:220px;display:none}
  .lang[aria-expanded="true"] .lang__panel{display:block}
  .lang__list{list-style:none;margin:0;padding:4px}
  .lang__list li a{display:block;padding:.5rem .6rem;border-radius:8px;color:inherit}
  .lang__list li a:hover{background:color-mix(in srgb,var(--brand) 10%,transparent)}

  .panels{position:relative}
  .panel{position:absolute;left:0;right:0;top:100%;transform:translateY(12px);display:none;background:var(--bg);border-top:1px solid color-mix(in srgb,var(--ink) 10%,transparent);box-shadow:var(--shadow);padding-block:20px;z-index:var(--z-panel)}
  .panel.is-open{display:block}
  .panel__grid{display:grid;gap:24px;grid-template-columns:repeat(4,minmax(0,1fr))}
  .panel__col h4{margin:0 0 8px;font-size:.95rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .panel__link{display:flex;align-items:center;gap:.6rem;padding:.5rem;border-radius:10px}
  .panel__link:hover{background:color-mix(in srgb,var(--brand) 8%,transparent)}
  .chip{font-size:.75rem;padding:.1rem .4rem;border-radius:6px;border:1px solid color-mix(in srgb,var(--ink) 12%,transparent);color:var(--muted)}

  .drawer{position:fixed;inset:0;background:var(--bg);z-index:var(--z-drawer);transform:translateY(-100%);transition:transform .25s ease;display:flex;flex-direction:column}
  .drawer.is-open{transform:translateY(0)}
  .drawer__head{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid color-mix(in srgb,var(--ink) 12%,transparent)}
  .drawer__body{overflow:auto;padding:10px 20px 24px}
  .acc{border-top:1px solid color-mix(in srgb,var(--ink) 12%,transparent)}
  .acc__btn{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 0;border:none;background:transparent;color:inherit;font-weight:600}
  .acc__panel{display:none;padding:0 0 10px 0}
  .acc__panel.is-open{display:block}
  .sublist{list-style:none;margin:0;padding:0}
  .sublist a{display:block;padding:10px;border-radius:10px}
  .sublist a:hover{background:color-mix(in srgb,var(--brand) 10%,transparent)}

  @media (max-width: 991px){
    .nav{display:none}
    .hamburger{display:inline-grid}
    .panel{display:none!important}
    .cta{padding:.55rem .9rem}
  }
  @media (prefers-reduced-motion: reduce){
    .panel,.drawer{transition:none}
    .nav__btn .chev{transition:none}
  }
</style>

<a href="#main" class="skip-link">Pomiń do treści</a>

<header class="site-header" id="header">
  <div class="container navbar">
    <a class="brand" href="/" aria-label="Strona główna">
      <span class="brand__logo" aria-hidden="true">K</span>
      <span class="brand__name">Kras-Trans</span>
    </a>

    <!-- Primary nav (desktop) -->
    <nav class="nav" aria-label="Główna nawigacja">
      <ul class="nav__list" id="navList" role="menubar" aria-label="Główne pozycje"></ul>
    </nav>

    <!-- Actions -->
    <div class="actions">
      <div class="lang" data-lang aria-expanded="false">
        <button class="icon-btn" aria-haspopup="true" aria-expanded="false" aria-controls="lang-panel" title="Języki">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 5h16M4 12h16M4 19h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <div id="lang-panel" class="lang__panel" role="menu" aria-label="Wybierz język">
          <ul class="lang__list" id="langList"></ul>
        </div>
      </div>

      <button id="themeToggle" class="icon-btn" aria-label="Przełącz motyw">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path id="themeIcon" d="M12 3a9 9 0 100 18 7 7 0 010-18z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <a href="#quote" class="cta">Wycena</a>

      <button class="icon-btn hamburger" id="hamburger" aria-expanded="false" aria-controls="drawer" aria-label="Menu">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mega panels (desktop) — generowane z JS -->
  <div class="panels" id="panels"></div>
</header>

<!-- Drawer (mobile) — generowany z JS -->
<div class="drawer" id="drawer" hidden>
  <div class="drawer__head">
    <div class="brand"><span class="brand__logo">K</span><span class="brand__name">Kras-Trans</span></div>
    <button class="icon-btn" id="drawerClose" aria-label="Zamknij menu">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </div>
  <div class="drawer__body">
    <nav aria-label="Menu mobilne" id="mobileNav"></nav>
  </div>
</div>

<script>
  /* =========================
     JS: pobieranie z API + Mega Menu & Drawer
     ========================= */

  // ---- KONFIGURACJA ----
  const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbyQcsU1wSCV6NGDQm8VIAGpZkL1rArZe1UZ5tutTkjJiKZtr4MjQZcDFzte26VtRJJ2KQ/exec?key=kb6mWQJQ3hTtY0m1GQ7v2rX1pC5n9d8zA4s6L2u',
    BRAND: 'Kras-Trans',
    DEFAULT_LANG: 'pl'
  };

  // ---- UTIL ----
  const qs = (sel, ctx=document) => ctx.querySelector(sel);
  const qsa = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const slugify = (s='') => (s || '').toString().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/&/g,'-and-').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').replace(/-{2,}/g,'-');

  const header = qs('#header');
  const sentinel = qs('.sentinel');

  // ---- Sticky header: solid after hero ----
  const io = (sentinel && 'IntersectionObserver' in window) ? new IntersectionObserver(entries=>{
    entries.forEach(e=> header.classList.toggle('is-scrolled', !e.isIntersecting));
  }, {rootMargin:'-72px 0px 0px 0px'}) : null;
  if(io){ io.observe(sentinel); }
  else {
    const onScroll = ()=> header.classList.toggle('is-scrolled', window.scrollY>20);
    onScroll();
    window.addEventListener('scroll', onScroll, {passive:true});
  }

  // ---- Theme toggle ----
  const themeBtn = qs('#themeToggle');
  const rootEl = document.documentElement;
  const applyTheme = t => rootEl.setAttribute('data-theme', t);
  const savedTheme = localStorage.getItem('theme'); if(savedTheme) applyTheme(savedTheme);
  themeBtn?.addEventListener('click', ()=>{
    const cur = rootEl.getAttribute('data-theme') || 'auto';
    const next = cur==='dark' ? 'light' : (cur==='light' ? 'auto' : 'dark');
    applyTheme(next); localStorage.setItem('theme', next);
    themeBtn.title = `Motyw: ${next}`;
  });

  // ---- Drawer (mobile) ----
  const drawer = qs('#drawer'), hamburger = qs('#hamburger'), drawerClose = qs('#drawerClose');
  function lockBody(lock){ document.body.style.overflow = lock ? 'hidden' : ''; }
  function openDrawer(){ drawer.hidden=false; drawer.classList.add('is-open'); hamburger.setAttribute('aria-expanded','true'); lockBody(true); trapFocus(drawer); closePanels(); }
  function closeDrawer(){ drawer.classList.remove('is-open'); hamburger.setAttribute('aria-expanded','false'); lockBody(false); setTimeout(()=>{ drawer.hidden=true; },200); releaseFocus(); hamburger.focus(); }
  hamburger?.addEventListener('click', openDrawer);
  drawerClose?.addEventListener('click', closeDrawer);
  drawer?.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDrawer(); });
  let lastFocused = null;
  function trapFocus(node){ const f = qsa('a[href],button:not([disabled]),[tabindex]:not([tabindex="-1"])', node);
    if(!f.length) return; const first=f[0], last=f[f.length-1]; lastFocused=document.activeElement; first.focus();
    function h(e){ if(e.key!=='Tab') return; if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
                  else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); } }
    node.__trap=h; node.addEventListener('keydown', h);
  }
  function releaseFocus(){ if(drawer.__trap) drawer.removeEventListener('keydown', drawer.__trap); lastFocused && lastFocused.focus(); }

  // ---- Desktop mega panels ----
  function closePanels(){
    qsa('.nav__btn[data-panel]').forEach(b=> b.setAttribute('aria-expanded','false'));
    qsa('.panel').forEach(p=> { p.classList.remove('is-open'); p.hidden = true; });
    document.removeEventListener('keydown', onEscClose);
    document.removeEventListener('click', onDocClick);
  }
  function onEscClose(e){ if(e.key==='Escape'){ closePanels(); } }
  function onDocClick(e){ const inHeader = header.contains(e.target); const onBtn = e.target.closest('.nav__btn[data-panel]'); const onPanel = e.target.closest('.panel'); if(!inHeader || (!onBtn && !onPanel)) closePanels(); }
  function openPanel(id, focusFirst=false){
    closePanels();
    const btn = qs(`.nav__btn[data-panel="${id}"]`);
    const panel = qs(`#panel-${id}`);
    if(!btn || !panel) return;
    btn.setAttribute('aria-expanded','true'); panel.hidden=false; panel.classList.add('is-open');
    if(focusFirst){ const f=panel.querySelector('a,button'); f && f.focus(); }
    document.addEventListener('keydown', onEscClose);
    document.addEventListener('click', onDocClick);
  }
  header.addEventListener('mouseleave', ()=> window.matchMedia('(min-width: 992px)').matches && closePanels());

  // ---- Language dropdown (desktop) ----
  const langWrap = qs('[data-lang]');
  if(langWrap){
    const langBtn = langWrap.querySelector('button');
    langBtn.addEventListener('click', ()=>{
      const expanded = langWrap.getAttribute('aria-expanded') === 'true';
      langWrap.setAttribute('aria-expanded', String(!expanded));
      langBtn.setAttribute('aria-expanded', String(!expanded));
    });
    langWrap.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ langWrap.setAttribute('aria-expanded','false'); langWrap.querySelector('button').setAttribute('aria-expanded','false'); langWrap.querySelector('button').focus(); }
    });
    document.addEventListener('click', e=>{
      if(!langWrap.contains(e.target)) { langWrap.setAttribute('aria-expanded','false'); langWrap.querySelector('button').setAttribute('aria-expanded','false'); }
    });
  }

  // =========================
  //  ŁADOWANIE DANYCH Z CMS
  // =========================
  async function fetchCMS(){
    const url = CONFIG.API_URL;
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('CMS API error: '+res.status);
    return await res.json();
  }

  function currentLangFromPath(){
    const seg = (location.pathname.split('/').filter(Boolean)[0] || '').toLowerCase();
    return /^[a-z]{2}$/.test(seg) ? seg : CONFIG.DEFAULT_LANG;
  }
  function currentSlugFromPath(){
    const parts = location.pathname.split('/').filter(Boolean);
    return parts.length>=2 ? decodeURIComponent(parts[1]) : '';
  }
  function buildRoutesMap(routesRows){
    const byKey = {}; const reverse = {};
    routesRows.forEach(r=>{
      const key = (r.slugKey||r.slugkey||'').trim();
      if(!key) return;
      const obj = { pl:r.pl||'', en:r.en||'', de:r.de||'', fr:r.fr||'', it:r.it||'', ru:r.ru||'', ua:r.ua||r.uk||'' };
      byKey[key] = obj;
      Object.entries(obj).forEach(([L,slug])=>{
        reverse[`${L}/${(slug||'').trim()}`] = key;
        if(key==='home') reverse[`${L}/`] = 'home';
      });
    });
    return { byKey, reverse };
  }
  function hrefFor(routesByKey, slugKey, lang){
    const s = (routesByKey[slugKey] && routesByKey[slugKey][lang]) || '';
    return `/${lang}/${s ? s+'/' : ''}`;
  }

  function buildHeaderFromCMS(cms){
    const navList   = qs('#navList');
    const panelsBox = qs('#panels');
    const mobileNav = qs('#mobileNav');
    const langList  = qs('#langList');

    const { byKey, reverse } = buildRoutesMap(cms.routes || []);
    const curLang = currentLangFromPath();
    const curSlug = currentSlugFromPath();
    const curKey  = reverse[`${curLang}/${curSlug}`] || (curSlug ? null : 'home');

    // Brand href
    const brandA = qs('.brand'); if(brandA) brandA.href = hrefFor(byKey, 'home', curLang);

    // ===== JĘZYKI =====
    const locales = ['pl','en','de','fr','it','ru','ua'];
    langList.innerHTML = locales.map(L=>{
      const label = {pl:'🇵🇱 Polski',en:'🇬🇧 English',de:'🇩🇪 Deutsch',fr:'🇫🇷 Français',it:'🇮🇹 Italiano',ru:'🇷🇺 Русский',ua:'🇺🇦 Українська'}[L] || L;
      const href = curKey ? hrefFor(byKey, curKey, L) : `/${L}/`;
      return `<li><a href="${href}" role="menuitem" data-lang-set="${L}">${label}</a></li>`;
    }).join('');

    // ===== NAV (desktop + panels) =====
    const all = (cms.nav||[]).map(n=>({
      lang:(n.lang||'').toLowerCase(),
      label:String(n.label||'').trim(),
      href:String(n.href||'').trim(),
      parent:String(n.parent||'').trim(),
      order:Number(n.order||0),
      enabled: String(n.enabled||'').toLowerCase()!=='false'
    })).filter(n=>n.enabled && n.lang===curLang && n.href && !/\/\#/.test(n.href));

    // grupy po parent
    const groups = {};
    const rootLinks = [];
    all.sort((a,b)=> (a.order||0)-(b.order||0)).forEach(item=>{
      if(item.parent){
        const key = slugify(item.parent);
        (groups[key] ||= { title:item.parent, items:[] }).items.push(item);
      }else{
        rootLinks.push(item);
      }
    });

    // zbuduj top-level <li> + panele
    navList.innerHTML = '';
    panelsBox.innerHTML = '';

    // 1) Grupy (każdy parent -> przycisk + panel)
    Object.entries(groups).forEach(([gid, grp])=>{
      const btn = document.createElement('li'); btn.setAttribute('role','none');
      btn.innerHTML = `
        <button class="nav__btn" role="menuitem" aria-haspopup="true" aria-expanded="false" data-panel="${gid}">
          ${grp.title}
          <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>`;
      navList.appendChild(btn);

      const panel = document.createElement('div');
      panel.className = 'panel'; panel.id = `panel-${gid}`; panel.hidden = true;
      const colA = grp.items.filter((_,i)=> i%2===0);
      const colB = grp.items.filter((_,i)=> i%2===1);
      panel.innerHTML = `
        <div class="container panel__grid" style="grid-template-columns:repeat(2,minmax(0,1fr))">
          <div class="panel__col">
            <h4>${grp.title}</h4>
            ${colA.map(it=>`<a class="panel__link" href="${it.href}"><strong>${it.label}</strong></a>`).join('')}
          </div>
          <div class="panel__col">
            <h4>&nbsp;</h4>
            ${colB.map(it=>`<a class="panel__link" href="${it.href}"><strong>${it.label}</strong></a>`).join('')}
          </div>
        </div>`;
      panelsBox.appendChild(panel);
    });

    // 2) Linki bez parent (proste pozycje)
    rootLinks.forEach(it=>{
      const li = document.createElement('li'); li.setAttribute('role','none');
      li.innerHTML = `<a class="nav__btn" role="menuitem" href="${it.href}">${it.label}</a>`;
      navList.appendChild(li);
    });

    // Active state prosty (dopasowanie href do ścieżki)
    const curPath = location.pathname.replace(/\/+$,'/') || '/';
    qsa('#navList a').forEach(a=>{
      const href = a.getAttribute('href')||'';
      if(href && href===curPath) a.setAttribute('aria-current','page');
    });

    // Handlery dla dynamicznych przycisków
    qsa('.nav__btn[data-panel]').forEach(btn=>{
      const id = btn.dataset.panel;
      btn.addEventListener('click', ()=> {
        const isOpen = btn.getAttribute('aria-expanded')==='true';
        isOpen ? closePanels() : openPanel(id);
      });
      btn.addEventListener('mouseenter', ()=> window.matchMedia('(min-width: 992px)').matches && openPanel(id));
    });

    // ===== NAV MOBILNY =====
    mobileNav.innerHTML = [
      ...Object.entries(groups).map(([gid, grp])=>`
        <div class="acc">
          <button class="acc__btn" aria-expanded="false">${grp.title}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <div class="acc__panel">
            <ul class="sublist">
              ${grp.items.map(it=>`<li><a href="${it.href}">${it.label}</a></li>`).join('')}
            </ul>
          </div>
        </div>`).join(''),
      rootLinks.length ? `<div class="acc" style="border-top:none">
        <div class="acc__panel is-open">
          <ul class="sublist">
            ${rootLinks.map(it=>`<li><a href="${it.href}">${it.label}</a></li>`).join('')}
          </ul>
        </div>
      </div>` : ''
    ].join('');

    qsa('#mobileNav .acc').forEach(acc=>{
      const btn = acc.querySelector('.acc__btn'); const panel = acc.querySelector('.acc__panel');
      if(!btn || !panel) return;
      btn.addEventListener('click', ()=>{
        const open = btn.getAttribute('aria-expanded')==='true';
        btn.setAttribute('aria-expanded', String(!open));
        panel.classList.toggle('is-open', !open);
      });
    });
  }

  // INIT
  (async function init(){
    try{
      const cms = await fetchCMS();
      if(!cms || cms.ok === false) throw new Error('Brak danych CMS');
      buildHeaderFromCMS(cms);
    }catch(err){
      console.error(err);
      qs('#navList').innerHTML = `
        <li role="none"><a class="nav__btn" role="menuitem" href="/pl/">Home</a></li>
        <li role="none"><a class="nav__btn" role="menuitem" href="/pl/kontakt/">Kontakt</a></li>`;
      qs('#langList').innerHTML = `
        <li><a href="/pl/" role="menuitem">🇵🇱 Polski</a></li>
        <li><a href="/en/" role="menuitem">🇬🇧 English</a></li>`;
    }
  })();
</script>

