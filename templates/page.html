{% import '_macros/seo.html' as SEO %}

{# ================= SAFE DEFAULTS ================= #}
{% set BRAND    = SEO.brand(company) %}
{% set _slug    = (page.slugKey or page.slug or 'home') if page is defined else 'home' %}
{% set _lang    = (page.lang or 'pl') if page is defined else 'pl' %}
{% set PAGES    = pages   if pages   is defined else [] %}
{% set BLOCKS   = blocks  if blocks  is defined else [] %}
{% set HREFLANG = hreflang if hreflang is defined else {} %}
{% set NAV_CFG  = nav_cfg if nav_cfg is defined else {} %}

{# Fallback i18n (gdy strings puste) #}
{% set I18N = {
  'pl': {'claim':'Kompleksowe usługi transportowe','hero_cta_primary':'Wyceń transport teraz'},
  'en': {'claim':'Full-stack transport services','hero_cta_primary':'Get a quote'},
  'de': {'claim':'Umfassende Transportdienste','hero_cta_primary':'Angebot anfordern'},
  'fr': {'claim':'Services de transport complets','hero_cta_primary':'Demander un devis'},
  'it': {'claim':'Servizi di trasporto completi','hero_cta_primary':'Richiedi preventivo'},
  'ru': {'claim':'Комплексные транспортные услуги','hero_cta_primary':'Запросить расчёт'},
  'ua': {'claim':'Комплексні транспортні послуги','hero_cta_primary':'Кошторис'}
} %}
{% set STR = (strings if strings is defined and strings else I18N.get(_lang, I18N['pl'])) %}

{# Link resolver: najpierw hreflang -> potem /{lang}/{slug}/ #}
{% macro url_of(slugkey, lang) -%}
  {%- set m = HREFLANG[slugkey] if HREFLANG and (slugkey in HREFLANG) else {} -%}
  {%- if m and (lang in m) -%}{{ m[lang] }}
  {%- else -%}
    {%- if slugkey == 'home' -%}/{{ lang }}/
    {%- else -%}/{{ lang }}/{{ slugkey }}/
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

<!doctype html>
<html lang="{{ _lang }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ SEO.seo_title(page, BRAND) }}</title>
  <meta name="description" content="{{ SEO.meta_desc(page) }}">
  <link rel="canonical" href="{{ SEO.canon(page) }}">
  {{ SEO.hreflang_links(_slug, HREFLANG) | safe }}

  {# CSS: trzymać jedną paczkę /assets/css/app.css #}
  <link rel="stylesheet" href="/assets/css/app.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="/assets/css/app.css"></noscript>
</head>
<body>
  {% include '_partials/header.html' %}

 <main id="main" role="main">
  {# ========== HOME (slug = home) ========== #}
  {% if _slug == 'home' %}
    <!-- HERO -->
    <section class="hero">
      <div class="container hero-wrap">
        <div class="hero-copy">
          <span class="claim">{{ page.claim or STR.claim }}</span>
          <h1>{{ page.h1 or page.title }}</h1>
          {% if page.lead %}<p class="lead" data-lead>{{ page.lead }}</p>{% endif %}
          <p class="hero-cta">
            <a class="btn primary" href="#quote">{{ STR.hero_cta_primary }}</a>
          </p>
        </div>
        {% if page.hero_video %}
          <video class="hero-media" muted loop playsinline preload="none"
                 poster="{{ page.hero_poster or '' }}" width="1680" height="720">
            <source src="{{ page.hero_video }}" type="video/mp4">
          </video>
        {% elif page.hero_image %}
          <img class="hero-media" src="{{ page.hero_image }}" alt="{{ page.hero_alt or page.h1 }}"
               width="1680" height="720" loading="eager" fetchpriority="high">
        {% endif %}
      </div>
    </section>

    {# OFERTA: z bloków „offer” albo ze stron typu „service” #}
    {% set offers = BLOCKS
      |selectattr('block','equalto','offer')
      |selectattr('lang','equalto',_lang)
      |selectattr('page','equalto','home')
      |selectattr('enabled','ne',False)
      |list %}
    {% if not offers|length %}
      {% set offers = PAGES
        |selectattr('type','equalto','service')
        |selectattr('lang','equalto',_lang)
        |list %}
    {% endif %}

    {% if offers|length %}
    <section class="section split-hero split-hero--narrow" id="offer-reveal" data-section="offers" aria-label="Oferta">
      <div class="split-hero__sticky">
        <div class="split-hero__stack">
          <div class="split-hero__title" aria-hidden="true">
            <span class="title-half title-left">{{ strings.offers_title or 'Nasza oferta' }}</span>
            <span class="title-half title-right">{{ strings.offers_title or 'Nasza oferta' }}</span>
          </div>
          <h2 class="visually-hidden">{{ strings.offers_title or 'Nasza oferta' }}</h2>

          <div class="split-hero__rail tilt-cards" id="offer-rail" role="list" aria-label="Usługi">
            {% for it in offers|sort(attribute='order') %}
              {% set url = it.href or it.url or '/' ~ _lang ~ '/' ~ (it.slug or '') ~ '/' %}
              <a role="listitem" class="offer-card" href="{{ url }}">
                {% if it.media %}<img src="{{ it.media }}" alt="" width="{{ it.img_w or 1280 }}" height="{{ it.img_h or 720 }}" loading="lazy" decoding="async">{% endif %}
                <span class="offer-card__title">{{ it.h1 or it.title or it.seo_title or it.slug }}</span>
                {% if it.lead or it.desc or it.meta_desc %}<span class="offer-card__desc" data-md>{{ it.lead or it.desc or it.meta_desc }}</span>{% endif %}
              </a>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="sep sep--morph" data-morph="wave-2" aria-hidden="true"></div>
    </section>
    {% endif %}

    <!-- MAPA / KIERUNKI -->
    <section class="section" id="kierunki" data-style="glass" aria-label="{{ strings.routes_title or 'Kierunki' }}">
      <div class="container text"><h2>{{ strings.routes_title or 'Kierunki' }}</h2></div>
      <div class="container">
        <div class="iframe-wrap" style="aspect-ratio:16/9">
          <iframe class="routes-map" title="Mapa kierunków"
                  loading="lazy"
                  src="/assets/media/mapa-kierunkow-kras-trans.html"
                  sandbox="allow-scripts allow-same-origin"
                  referrerpolicy="no-referrer"></iframe>
        </div>
      </div>
    </section>

    {# FAQ z bloków (opcjonalnie) #}
    {% set home_faq = BLOCKS
      |selectattr('block','equalto','faq')
      |selectattr('lang','equalto',_lang)
      |selectattr('page','equalto','home')
      |selectattr('enabled','ne',False)
      |list %}
    {% if home_faq|length %}
    <section class="section faq" id="faq" aria-label="FAQ">
      <div class="container">
        <h2>{{ strings.faq_title or 'FAQ' }}</h2>
        <div class="faq__list">
          {% for b in home_faq|sort(attribute='order') %}
            <details>
              <summary>{{ b.title }}</summary>
              {% if b.body_md %}<div class="prose" data-md>{{ b.body_md }}</div>{% endif %}
            </details>
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

  {# ========== INNE STRONY (nie home) ========== #}
  {% else %}
    {% if page_html is defined and page_html %}
      {{ page_html|safe }}
    {% else %}
      <!-- HERO (default) -->
      <section class="hero">
        <div class="container hero-wrap">
          <div class="hero-copy">
            <span class="claim">{{ page.claim or STR.claim }}</span>
            <h1>{{ page.h1 or page.title }}</h1>
            {% if page.lead %}<p class="lead" data-lead>{{ page.lead }}</p>{% endif %}
          </div>
        </div>
      </section>

      {% set page_blocks = BLOCKS
         |selectattr('lang','equalto',_lang)
         |selectattr('page','equalto',_slug)
         |selectattr('enabled','ne',False)
         |list %}
      {% if page_blocks|length %}
      <section class="section">
        <div class="container grid">
          {% for b in page_blocks|sort(attribute='order') %}
          <article class="card">
            {% if b.title %}<h3>{{ b.title }}</h3>{% endif %}
            {% if b.lead %}<p class="muted" data-md>{{ b.lead }}</p>{% endif %}
            {% if b.body_md %}<div class="prose" data-md>{{ b.body_md }}</div>{% endif %}
            {% if b.href and b.cta_label %}<p><a class="btn" href="{{ b.href }}">{{ b.cta_label }}</a></p>{% endif %}
          </article>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      {% if page.body_md %}
      <section class="section">
        <div class="container text">
          <div class="prose" data-md>{{ page.body_md }}</div>
        </div>
      </section>
      {% endif %}
    {% endif %}
  {% endif %}
</main>
  <script type="application/ld+json">{{ SEO.structured(page, company, BLOCKS)|tojson }}</script>
  {% include '_partials/footer.html' %}

  {# Minimalny formatter: \n -> <br>, akapity i **bold** dla [data-lead]/[data-md] #}
  <script>
  (function(){
    function fmt(s){
      return (s||'')
        .replace(/\r\n/g,'\n')
        .replace(/\n\n+/g,'</p><p>')
        .replace(/\n/g,'<br>')
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    }
    document.querySelectorAll('[data-lead]').forEach(el=>{ el.innerHTML = fmt(el.textContent); });
    document.querySelectorAll('[data-md]').forEach(el=>{
      var t = el.textContent.trim(); if(!t) return;
      el.innerHTML = '<p>'+fmt(t)+'</p>';
    });
  })();
  </script>
</body>
</html>
