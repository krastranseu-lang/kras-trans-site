{% set BRAND   = (company[0].name if company is defined and company|length > 0 and company[0].name else 'Kras-Trans') %}
{% set _slug   = page.slugKey or page.slug or 'home' %}
{% set _lang   = page.lang or 'pl' %}

{# ---- i18n fallback per jƒôzyk ---- #}
{% set I18N = {
  'pl': {'offers_title':'Nasza oferta','routes_title':'Kierunki','hero_cta_primary':'Wyce≈Ñ transport teraz','hero_cta_secondary':'Zadzwo≈Ñ 24/7'},
  'en': {'offers_title':'Our offer','routes_title':'Routes','hero_cta_primary':'Get a quote','hero_cta_secondary':'Call 24/7'},
  'de': {'offers_title':'Unser Angebot','routes_title':'Routen','hero_cta_primary':'Angebot anfordern','hero_cta_secondary':'Anrufen 24/7'},
  'fr': {'offers_title':'Notre offre','routes_title':'Itin√©raires','hero_cta_primary':'Demander un devis','hero_cta_secondary':'Appeler 24/7'},
  'it': {'offers_title':'La nostra offerta','routes_title':'Rotte','hero_cta_primary':'Richiedi preventivo','hero_cta_secondary':'Chiama 24/7'},
  'ru': {'offers_title':'–ù–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ','routes_title':'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è','hero_cta_primary':'–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞—Å—á—ë—Ç','hero_cta_secondary':'–ü–æ–∑–≤–æ–Ω–∏—Ç—å 24/7'},
  'ua': {'offers_title':'–ù–∞—à–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è','routes_title':'–ù–∞–ø—Ä—è–º–∫–∏','hero_cta_primary':'–ö–æ—à—Ç–æ—Ä–∏—Å','hero_cta_secondary':'–î–∑–≤–æ–Ω–∏—Ç–∏ 24/7'}
} %}
{% set STR     = (strings if strings is defined and strings) or {} %}
{% set T       = I18N[_lang] %}

{% set _canon  = page.canonical_path or '/' ~ _lang ~ '/' ~ (_slug != 'home' and (_slug ~ '/') or '') %}
{% set COMPANY = (company if company is defined else []) %}
{% set PHONE   = (COMPANY and COMPANY[0].telephone) or '+48793927467' %}
{% set PAGES   = (pages   if pages   is defined else []) %}
{% set BLOCKS  = (blocks  if blocks  is defined else []) %}
{% set HREFLANG= (hreflang if hreflang is defined else {}) %}
{% set NAV_CFG = (nav_cfg if nav_cfg is defined else {}) %}

{# wygodne hrefy z mapy hreflang; je≈õli brak ‚Äî sensowny fallback #}
{% set HL = HREFLANG %}
{% set href_contact  = (HL.get('contact') and HL.get('contact').get(_lang)) or '/' ~ _lang ~ '/contact/' %}
{% set href_about    = (HL.get('about') and HL.get('about').get(_lang)) or '/' ~ _lang ~ '/about/' %}
{% set href_licenses = (HL.get('licenses-insurance') and HL.get('licenses-insurance').get(_lang)) or '/' ~ _lang ~ '/licenses-insurance/' %}

<!doctype html>
<html lang="{{ _lang }}" class="no-motion">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#ff7a1a">

  <title>{{ page.seo_title or page.title or 'Kras-Trans' }}</title>
  <meta name="description" content="{{ page.meta_desc or page.lead or '' }}">

  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ page.og_title or page.seo_title or page.title }}">
  <meta property="og:description" content="{{ page.og_desc or page.meta_desc or page.lead }}">
  <meta property="og:image" content="{{ page.og_image or '/assets/media/og-default.jpg' }}">
  <meta property="og:url" content="{{ _canon }}">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ page.seo_title or page.title }}">
  <meta name="twitter:description" content="{{ page.meta_desc or page.lead }}">
  <meta name="twitter:image" content="{{ page.og_image or '/assets/media/og-default.jpg' }}">
  <link rel="canonical" href="{{ _canon }}">

  <!-- czcionki / CSS -->
  <link rel="preload" href="/assets/fonts/InterVariable.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/assets/fonts/InterVariable-Italic.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/assets/css/kras-global.css" as="style">
  <link rel="preload" href="/assets/css/kras-ui.css" as="style">
  <link rel="stylesheet" href="/assets/css/kras-global.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="/assets/css/kras-ui.css"    media="print" onload="this.media='all'">
  <noscript>
    <link rel="stylesheet" href="/assets/css/kras-global.css">
    <link rel="stylesheet" href="/assets/css/kras-ui.css">
  </noscript>
  <link rel="stylesheet" href="/assets/kt.css">
  <style>.visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);clip-path:inset(50%);white-space:nowrap;border:0}</style>

  {# hreflang tylko dla bie≈ºƒÖcej strony #}
  {% set _hreflang_map = HL.get(_slug) or {} %}
  <script>
  (function(){
    var map = {{ _hreflang_map|tojson }};
    var keys = Object.keys(map||{});
    if(!keys.length) return;
    keys.forEach(function(L){
      var a=document.createElement('link');
      a.rel='alternate';
      a.hreflang=(L==='ua')?'uk':L;
      a.href=map[L];
      document.head.appendChild(a);
    });
    var x=document.createElement('link');
    x.rel='alternate'; x.hreflang='x-default';
    x.href=map['en']||map['pl']||map[keys[0]];
    document.head.appendChild(x);
  })();
  </script>
</head>

<body>
  <!-- T≈Ça (opcjonalne) -->
  <div id="bg-grid" aria-hidden="true"></div>
  <canvas id="bg-canvas" aria-hidden="true" hidden></canvas>

  <!-- ================= HEADER ================= -->
  <header class="site-header" id="header">
    <div class="container navbar">
      <a class="brand" href="/{{ _lang }}/" aria-label="Strona g≈Ç√≥wna">
        <span class="brand__logo" aria-hidden="true">K</span>
        <span class="brand__name">{{ BRAND }}</span>
      </a>

      <nav class="nav" aria-label="G≈Ç√≥wna nawigacja">
        <ul class="nav__list" role="menubar">
          <li role="none">
            <button class="nav__btn" role="menuitem" aria-haspopup="true" aria-expanded="false" data-panel="services">
              Us≈Çugi <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
          </li>
          <li role="none">
            <button class="nav__btn" role="menuitem" aria-haspopup="true" aria-expanded="false" data-panel="industries">
              Dla firm <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
          </li>
          <li role="none">
            <button class="nav__btn" role="menuitem" aria-haspopup="true" aria-expanded="false" data-panel="resources">
              Zasoby <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
          </li>
          <li role="none"><a class="nav__btn" role="menuitem" href="{{ href_about }}">O nas</a></li>
          <li role="none"><a class="nav__btn" role="menuitem" href="/{{ _lang }}/flota/">Flota</a></li>
          <li role="none"><a class="nav__btn" role="menuitem" href="/{{ _lang }}/blog/">Blog</a></li>
        </ul>
      </nav>

      <div class="actions">
        <div class="lang" data-lang aria-expanded="false">
          <button class="icon-btn" aria-haspopup="true" aria-expanded="false" aria-controls="lang-panel" title="Jƒôzyki">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 5h16M4 12h16M4 19h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <div id="lang-panel" class="lang__panel" role="menu" aria-label="Wybierz jƒôzyk">
            <ul class="lang__list">
              <li><a href="/pl/" role="menuitem">üáµüá± Polski</a></li>
              <li><a href="/en/" role="menuitem">üá¨üáß English</a></li>
              <li><a href="/de/" role="menuitem">üá©üá™ Deutsch</a></li>
              <li><a href="/fr/" role="menuitem">üá´üá∑ Fran√ßais</a></li>
              <li><a href="/it/" role="menuitem">üáÆüáπ Italiano</a></li>
              <li><a href="/ru/" role="menuitem">üá∑üá∫ –†—É—Å—Å–∫–∏–π</a></li>
              <li><a href="/ua/" role="menuitem">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</a></li>
            </ul>
          </div>
        </div>

        <button id="themeToggle" class="icon-btn" aria-label="Prze≈ÇƒÖcz motyw">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path id="themeIcon" d="M12 3a9 9 0 100 18 7 7 0 010-18z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>

        <a href="#quote" class="cta">{{ STR.hero_cta_primary or T.hero_cta_primary }}</a>

        <button class="icon-btn hamburger" id="hamburger" aria-expanded="false" aria-controls="drawer" aria-label="Menu">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
    </div>

    <!-- MEGA PANELS (skr√≥cone; link Kontakt z hreflang) -->
    <div class="panels">
      <div class="panel" id="panel-services" hidden>
        <div class="container panel__grid">
          <div class="panel__col">
            <h4>Transport</h4>
            <a class="panel__link" href="/{{ _lang }}/transport-ekspresowy/"><strong>Ekspres bus 3,5 t</strong> <span class="chip">Same day</span></a>
            <a class="panel__link" href="/{{ _lang }}/tir/"><strong>Transport TIR (FTL/LTL)</strong></a>
            <a class="panel__link" href="/{{ _lang }}/przeprowadzki-b2b/"><strong>Przeprowadzki B2B</strong></a>
            <a class="panel__link" href="/{{ _lang }}/adr/"><strong>ADR*</strong> <span class="chip">po potwierdzeniu</span></a>
          </div>
          <div class="panel__col">
            <h4>Szybkie akcje</h4>
            <a class="panel__link" href="#quote"><strong>{{ STR.hero_cta_primary or T.hero_cta_primary }}</strong></a>
            <a class="panel__link" href="{{ href_contact }}"><strong>Kontakt</strong></a>
          </div>
        </div>
      </div>

      <div class="panel" id="panel-industries" hidden>
        <div class="container panel__grid">
          <div class="panel__col">
            <h4>Use cases</h4>
            <a class="panel__link" href="#"><strong>JIT / linie produkcyjne</strong></a>
            <a class="panel__link" href="#"><strong>Event logistics</strong></a>
          </div>
          <div class="panel__col">
            <h4>Dokumenty</h4>
            <a class="panel__link" href="#"><strong>Warunki wsp√≥≈Çpracy</strong></a>
          </div>
          <div class="panel__col">
            <h4>Kontakt B2B</h4>
            <a class="panel__link" href="{{ href_contact }}"><strong>Zostaw brief</strong></a>
          </div>
        </div>
      </div>

      <div class="panel" id="panel-resources" hidden>
        <div class="container panel__grid">
          <div class="panel__col">
            <h4>Materia≈Çy</h4>
            <a class="panel__link" href="/{{ _lang }}/blog/"><strong>Blog</strong></a>
          </div>
          <div class="panel__col">
            <h4>Informacje</h4>
            <a class="panel__link" href="{{ href_about }}"><strong>O firmie</strong></a>
            <a class="panel__link" href="/{{ _lang }}/flota/"><strong>Flota</strong></a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Drawer (mobile) ‚Äî skr√≥t -->
  <div class="drawer" id="drawer" hidden>
    <div class="drawer__head">
      <div class="brand"><span class="brand__logo">K</span><span class="brand__name">{{ BRAND }}</span></div>
      <button class="icon-btn" id="drawerClose" aria-label="Zamknij menu">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="drawer__body">
      <nav aria-label="Menu mobilne">
        <a class="sublist" href="{{ href_about }}" style="display:block;padding:14px 0">O nas</a>
        <a class="sublist" href="{{ href_contact }}" style="display:block;padding:14px 0">Kontakt</a>
        <div style="padding:16px 0;display:flex;gap:10px">
          <a class="cta" href="#quote" style="flex:1;justify-content:center">{{ STR.hero_cta_primary or T.hero_cta_primary }}</a>
          <a class="icon-btn" href="tel:{{ PHONE }}" aria-label="Zadzwo≈Ñ">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.86 19.86 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.89.31 1.76.57 2.6a2 2 0 0 1-.45 2.11L8 9a16 16 0 0 0 6 6l.57-.22a2 2 0 0 1 2.11.45c.84.26 1.71.45 2.6.57A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="2"/></svg>
          </a>
        </div>
      </nav>
    </div>
  </div>

  <!-- ================= MAIN ================= -->
  <main id="main" class="content" role="main">
    <!-- HERO -->
    <section class="hero" id="hero">
      <div class="container hero-wrap">
        <div class="hero-copy">
          <span class="claim">{{ page.claim or 'Kompleksowe us≈Çugi transportowe' }}</span>
          <h1>{{ page.h1 or page.title }}</h1>
          {% if page.lead %}<p class="lead" data-lead>{{ page.lead }}</p>{% endif %}
          <p class="hero-cta">
            <a class="btn primary" href="#quote">{{ STR.hero_cta_primary or T.hero_cta_primary }}</a>
            <a class="btn" href="tel:{{ PHONE }}">{{ STR.hero_cta_secondary or T.hero_cta_secondary }}</a>
          </p>
        </div>
        {% if page.hero_video %}
          <video class="hero-media" muted loop playsinline preload="none" poster="{{ page.hero_poster or '' }}" width="1680" height="720">
            <source src="{{ page.hero_video }}" type="video/mp4">
          </video>
        {% elif page.hero_image %}
          <img class="hero-media" src="{{ page.hero_image }}" alt="{{ page.hero_alt or page.h1 }}" width="1680" height="720" loading="eager" fetchpriority="high">
        {% endif %}
      </div>
    </section>

    {# ZBIERZ OFERTY (bloki ‚Äûoffer‚Äù dla tej strony/jƒôzyka, albo lista us≈Çug) #}
    {% set offers = BLOCKS|selectattr('block','equalto','offer')|selectattr('lang','equalto',_lang)|selectattr('page','equalto',_slug)|list %}
    {% if not offers|length %}
      {% set offers = PAGES|selectattr('type','equalto','service')|selectattr('lang','equalto',_lang)|list %}
    {% endif %}

    {% if offers|length %}
    <!-- OFERTA (kafelki) -->
    <section class="section split-hero split-hero--narrow" id="offer-reveal" data-section="offers" data-style="edge" data-accent="amber" aria-label="{{ STR.offers_aria or T.offers_title }}">
      <div class="split-hero__sticky">
        <div class="split-hero__stack">
          <div class="split-hero__title" aria-hidden="true">
            <span class="title-half title-left">{{ STR.offers_title or T.offers_title }}</span>
            <span class="title-half title-right">{{ STR.offers_title or T.offers_title }}</span>
          </div>
          <h2 class="visually-hidden">{{ STR.offers_title or T.offers_title }}</h2>

          <div class="split-hero__rail" id="offer-rail" role="list" aria-label="{{ STR.offers_list or T.offers_title }}">
            {% for it in offers|sort(attribute='order') %}
              {% set url = it.href or it.url or ((HL.get(it.slugKey or it.slug) and HL.get(it.slugKey or it.slug).get(_lang)) or '/' ~ _lang ~ '/' ~ (it.slug or '') ~ '/') %}
              <a role="listitem" class="offer-card" href="{{ url }}">
                {% if it.media %}<img src="{{ it.media }}" alt="" width="{{ it.img_w or 1280 }}" height="{{ it.img_h or 720 }}" loading="lazy" decoding="async">{% endif %}
                <span class="offer-card__title">{{ it.h1 or it.title or it.seo_title or it.slug }}</span>
                {% if it.lead or it.desc or it.meta_desc %}<span class="offer-card__desc" data-md>{{ it.lead or it.desc or it.meta_desc }}</span>{% endif %}
              </a>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="sep sep--morph" data-morph="wave-2" aria-hidden="true"></div>
    </section>
    {% endif %}

    <!-- KONTENT Z ARKUSZA -->
    {% if page.body_md %}
    <section class="section" id="content">
      <div class="container text prose" data-md>{{ page.body_md }}</div>
    </section>
    {% endif %}

    <!-- KIERUNKI -->
    <section class="section" id="kierunki" data-section="kierunki" data-style="glass">
      <div class="container text"><h2>{{ STR.routes_title or T.routes_title }}</h2></div>
      <div class="container">
        <div class="iframe-wrap">
          <iframe class="routes-map" title="Mapa kierunk√≥w" loading="lazy"
                  src="/assets/media/mapa-kierunkow-kras-trans.html"
                  sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer"></iframe>
        </div>
      </div>
    </section>
  </main>

  <!-- ================= FOOTER ================= -->
  <footer class="site-footer">
    <div class="container foot-row">
      <div>¬© {{ BRAND }}</div>
      <nav class="foot-nav">
        <a href="{{ href_contact }}">Kontakt</a>
        <a href="{{ href_about }}">O firmie</a>
        <a href="{{ href_licenses }}">Licencje &amp; ubezpieczenia</a>
      </nav>
    </div>
  </footer>

  <!-- ================= SCRIPTS ================= -->
  <script>window.KRAS_NAV = {{ NAV_CFG|tojson }};</script>
  <script src="/assets/js/kras-global.js" defer></script>
  <script src="/assets/js/menu-builder.js" defer></script>
  <script>(window.requestIdleCallback||window.setTimeout)(function(){var s=document.createElement('script');s.src='/assets/js/kras-ui.js';s.defer=true;document.body.appendChild(s);});</script>
  <script defer src="/assets/kt.js"></script>

  <!-- Formatowanie: lead + body_md -->
  <script>
  (function(){
    // lead: \n -> <br>, **bold**
    document.querySelectorAll('[data-lead], .lead').forEach(function(el){
      el.innerHTML = (el.textContent||'')
        .replace(/\\r\\n/g,'\n')
        .replace(/\n/g,'<br>')
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    });
    // body_md: akapity (puste linie), **bold**
    document.querySelectorAll('[data-md]').forEach(function(el){
      var src = (el.textContent||'').replace(/\\r\\n/g,'\n').trim();
      if(!src) return;
      var html = src.split(/\n{2,}/).map(function(block){
        return '<p>'+block.replace(/\n/g,'<br>')+'</p>';
      }).join('\n');
      html = html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
      el.innerHTML = html;
    });
  })();
  </script>
</body>
</html>
