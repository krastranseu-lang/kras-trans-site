<!doctype html>
<html lang="{{ page.lang or 'pl' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#0b0f17">

  {# ------ Bezpieczne aliasy ------ #}
  {% set strings = strings or {} %}
  {% set _title = page.seo_title or page.title or page.h1 or 'Kras-Trans' %}
  {% set _desc  = page.meta_desc  or page.description or page.lead or 'Transport i spedycja ‚Äî Polska & UE' %}

  <title>{{ _title }}</title>
  <meta name="description" content="{{ _desc }}">

  {# ------ Canonical + hreflang ------ #}
  {% set _lang  = (page.lang or 'pl')|lower %}
  {% set _slug  = page.slug or '' %}
  {% set _path  = '/' ~ _lang ~ '/' ~ (_slug ~ ('/' if _slug)) %}
  {% set _site  = SITE_URL or site_url or 'https://kras-trans.com' %}
  {% set _canon = _site ~ _path %}
  <link rel="canonical" href="{{ _canon }}">
  {% set samekey = page.slugKey or page.slug or 'home' %}
  {% for alt in (pages or []) | selectattr('slugKey','equalto',samekey) | list %}
    {% set _altpath = '/' ~ (alt.lang or 'pl')|lower ~ '/' ~ (alt.slug or '') ~ '/' %}
    <link rel="alternate" hreflang="{{ (alt.lang or 'pl')|lower }}" href="{{ _site ~ _altpath }}">
  {% endfor %}
  <link rel="alternate" hreflang="x-default" href="{{ _canon }}">

  {# ------ OpenGraph / Twitter ------ #}
  {% set ogimg = page.og_image or page.hero_image or 'assets/media/og-default.webp' %}
  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ _title }}">
  <meta property="og:description" content="{{ _desc }}">
  <meta property="og:url" content="{{ _canon }}">
  <meta property="og:image" content="{{ _site ~ '/' ~ ogimg|replace('^/','') }}">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ _title }}">
  <meta name="twitter:description" content="{{ _desc }}">
  <meta name="twitter:image" content="{{ _site ~ '/' ~ ogimg|replace('^/','') }}">

  {# ------ Google Search Console (je≈õli podane w ENV) ------ #}
  {% if GSC_VERIFICATION %}
    <meta name="google-site-verification" content="{{ GSC_VERIFICATION }}">
  {% endif %}

  {# ------ Wydajno≈õƒá: fonty + CSS ------ #}
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/InterVariable.woff2" crossorigin>
  <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/InterVariable-Italic.woff2" crossorigin>
  <link rel="stylesheet" href="/assets/css/kras-global.css">

  <style>
    /* drobny helper dostƒôpno≈õci */
    .visually-hidden{position:absolute!important;clip:rect(1px,1px,1px,1px);clip-path:inset(50%);height:1px;width:1px;overflow:hidden;white-space:nowrap}
  </style>
</head>
<body>
  <!-- T≈Ço: siatka + canvas ‚Äûpatyczki‚Äù (bez obrazk√≥w) -->
  <div id="bg-grid" aria-hidden="true"></div>
  <canvas id="bg-canvas" aria-hidden="true"></canvas>

  <!-- ===== HEADER (sticky) ===== -->
  <header class="site-header" role="banner">
    <div class="container header-grid">
      <!-- Logo / brand -->
      <a class="brand" href="/">{{ (company and company[0].name) or strings.brand or 'Kras-Trans' }}</a>

      <!-- HAK DLA MENU: pusty nav, JS go wype≈Çni i zdejmie 'hidden' -->
      <nav id="site-nav" class="nav" aria-label="{{ strings.nav_main or 'G≈Ç√≥wna nawigacja' }}" hidden></nav>

      <!-- CTA + prze≈ÇƒÖcznik tryb√≥w: system -> dark -> light -> paper -->
      <div class="header-actions">
        <button id="theme-toggle" class="icon-btn theme-toggle" type="button"
                aria-label="{{ strings.theme_toggle or 'Zmie≈Ñ motyw' }}"
                aria-pressed="false" title="Motyw">
          <span class="sun" aria-hidden="true"></span>
          <span class="moon" aria-hidden="true"></span>
          <span class="paper" aria-hidden="true"></span>
        </button>
        <a class="btn primary btn--shine" href="tel:{{ (company and company[0].telephone) or strings.phone or '+48793927467' }}">
          {{ strings.cta_call or 'Zadzwo≈Ñ 24/7' }}
        </a>
      </div>
    </div>
  </header>

  <main id="main" class="content" role="main">
    <!-- ===== HERO (bez sta≈Çego t≈Ça, 21:9) ===== -->
    <section class="hero" id="hero" aria-label="{{ strings.hero_aria or 'Hero' }}">
      <div class="container hero-wrap">
        <div class="hero-copy">
          <span class="claim">{{ page.claim or strings.claim or 'Kompleksowe us≈Çugi transportowe' }}</span>
          <h1>{{ page.h1 or page.title or 'Transport ‚Äî Polska & Europa' }}</h1>
          {% if page.lead %}<p>{{ page.lead }}</p>{% endif %}
          <p>
            <a class="btn primary" href="#kontakt">{{ strings.hero_cta_primary or 'Wycena 15 min' }}</a>
            <a class="btn" href="tel:{{ (company and company[0].telephone) or '+48793927467' }}">{{ strings.hero_cta_secondary or 'Zadzwo≈Ñ' }}</a>
          </p>
        </div>

        {% if page.hero_video %}
          <video class="hero-media" muted loop playsinline preload="none"
                 poster="{{ page.hero_poster or 'assets/media/hero.webp' }}"
                 width="1680" height="720">
            <source src="{{ page.hero_video }}" type="video/mp4">
          </video>
        {% elif page.hero_image %}
          <img class="hero-media" src="{{ page.hero_image }}"
               alt="{{ page.hero_alt or page.h1 or page.title }}"
               width="1680" height="720" fetchpriority="high">
        {% else %}
          <img class="hero-media" src="/assets/media/hero.webp"
               alt="{{ page.h1 or page.title }}" width="1680" height="720" fetchpriority="high">
        {% endif %}
      </div>
    </section>

    <!-- ===== OFERTA (kafelki z Arkusza; mobilnie poziomy scroll) ===== -->
    <section class="section --line" id="oferta" data-section="offers" aria-label="{{ strings.offers_aria or 'Nasza oferta' }}">
      <div class="container text">
        <h2>{{ strings.offers_title or 'Nasza oferta' }}</h2>
        {% if strings.offers_desc %}<p>{{ strings.offers_desc }}</p>{% endif %}
      </div>

      {% set offers_blocks = (blocks or [])
        | selectattr('block','equalto','offer')
        | selectattr('lang','equalto',_lang)
        | selectattr('page','equalto',samekey)
        | list %}
      {% set offers_pages = (pages or [])
        | selectattr('type','equalto','service')
        | selectattr('lang','equalto',_lang)
        | list %}
      {% set offers = offers_blocks if offers_blocks|length else offers_pages %}

      {% if offers|length %}
      <div class="container cards tilt-cards cards--wrap cards--scroll" data-equalize="true"
           aria-label="{{ strings.offers_list or 'Us≈Çugi (przesu≈Ñ w bok na telefonie)' }}"
           style="content-visibility:auto;contain-intrinsic-size:1px 1200px">
        {% for it in offers|sort(attribute='order') %}
          {% set url = it.href or it.url or ('/' ~ _lang ~ '/' ~ (it.slug or '') ~ '/') %}
          <article class="card offer">
            <div class="pad">
              <h3>{{ it.title or it.h1 or it.seo_title or it.slug }}</h3>
              {% if it.desc or it.lead or it.meta_desc %}
                <p>{{ it.desc or it.lead or it.meta_desc }}</p>
              {% endif %}
              {% if url %}<a class="btn" href="{{ url }}">{{ it.cta or strings.read_more or 'Poznaj us≈Çugƒô' }}</a>{% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
      {% endif %}

      <div class="sep sep--morph" data-morph="wave-2" aria-hidden="true"></div>
    </section>

    <!-- ===== FAQ (z Arkusza) ===== -->
    {% set page_faq = (faq or [])
      | selectattr('lang','equalto',_lang)
      | selectattr('page','equalto',samekey)
      | list %}
    {% if page_faq|length %}
    <section class="section --dots" id="faq" aria-label="{{ strings.faq_aria or 'Najczƒôstsze pytania' }}">
      <div class="container text"><h2>{{ strings.faq_title or 'FAQ ‚Äî najczƒôstsze pytania' }}</h2></div>
      <div class="container cards cards--wrap" data-equalize="true">
        {% for f in page_faq %}
          <details class="card"><div class="pad">
            <summary><strong>{{ f.question }}</strong></summary>
            <p>{{ f.answer }}</p>
          </div></details>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- ===== KONTAKT (bez sta≈Çego t≈Ça; przycisk spinner‚Üícheck) ===== -->
    <section class="section" id="kontakt" data-section="contact" aria-label="{{ strings.contact_aria or 'Kontakt i wycena' }}">
      <div class="container text">
        <h2>{{ strings.contact_title or 'Skontaktuj siƒô z nami' }}</h2>
        {% if strings.contact_desc %}<p>{{ strings.contact_desc }}</p>{% endif %}
      </div>

      <div class="container">
        <form class="card" method="post" action="{{ LEAD_ACTION or '/lead' }}" data-ajax="true">
          <div class="pad">
            <div class="cards cards--wrap" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
              <label class="card"><div class="pad"><input name="name"  type="text"  placeholder="{{ strings.form_name or 'Imiƒô i nazwisko' }}" required></div></label>
              <label class="card"><div class="pad"><input name="phone" type="tel"   placeholder="{{ strings.form_phone or 'Telefon' }}" required></div></label>
              <label class="card"><div class="pad"><input name="email" type="email" placeholder="E-mail" required></div></label>
            </div>
            <p><textarea name="message" placeholder="{{ strings.form_message or 'Tre≈õƒá zapytania' }}" rows="4" style="width:100%"></textarea></p>
            <p>
              <button class="btn primary btn--progress" type="submit" data-progress>
                <span class="btn__label">{{ strings.form_submit or 'Wy≈õlij' }}</span>
                <span class="btn__spinner" aria-hidden="true"></span>
                <span class="btn__check"   aria-hidden="true">‚úì</span>
              </button>
              <a class="btn" href="tel:{{ (company and company[0].telephone) or '+48793927467' }}">{{ strings.cta_call_short or 'Zadzwo≈Ñ' }}</a>
            </p>
          </div>
        </form>
      </div>
    </section>

    <!-- ===== SLOT NA WID≈ªETY Z ZEWN. SERWERA =====
         Jak u≈ºyƒá:
         - Ustaw data-embed-src="https://twoj-serwer/widget.html" (lub .json z HTML)
         - ≈Åaduje siƒô leniwie, dopiero gdy sekcja wejdzie w viewport.
         - Dla bezpiecznych skrypt√≥w u≈ºyj sandboxowanego <iframe> (patrz przyk≈Çad 2).
    -->
    <section class="section --line" id="widgets" aria-label="Wid≈ºety">
      <div class="container text"><h2>{{ strings.widgets_title or 'Dodatkowe modu≈Çy' }}</h2></div>

      <div class="container cards cards--wrap">
        <!-- Przyk≈Çad 1: wstrzykniƒôcie czystego HTML z Twojego serwera -->
        <article class="card"><div class="pad">
          <h3>Widget HTML (fetch & sanitize)</h3>
          <div class="embed" data-embed-src="https://example.com/widgets/kierunki.html"></div>
        </div></article>

        <!-- Przyk≈Çad 2: osadzony iframe (sandboks) -->
        <article class="card"><div class="pad">
          <h3>Mapa kierunk√≥w (iframe)</h3>
          <div class="iframe-wrap" style="aspect-ratio:16/9">
            <iframe
              loading="lazy"
              src="https://example.com/widgets/mapa.html"
              title="Kierunki"
              style="width:100%;height:100%;border:0;border-radius:12px"
              sandbox="allow-scripts allow-same-origin"
              referrerpolicy="no-referrer">
            </iframe>
          </div>
        </div></article>
      </div>
    </section>

    <!-- ===== POWIƒÑZANE ===== -->
    {% set related = (pages or [])
      | selectattr('lang','equalto',_lang)
      | selectattr('parentSlug','equalto',page.parentSlug)
      | rejectattr('slugKey','equalto',samekey)
      | list %}
    {% if related|length %}
    <section class="section --line" id="related">
      <div class="container text"><h2>{{ strings.related_title or 'PowiƒÖzane strony' }}</h2></div>
      <div class="container cards cards--wrap">
        {% for r in related[:6] %}
          <article class="card"><div class="pad">
            <h3><a href="/{{ _lang }}/{{ r.slug }}/">{{ r.h1 or r.title or r.seo_title }}</a></h3>
            {% if r.meta_desc %}<p>{{ r.meta_desc }}</p>{% endif %}
          </div></article>
        {% endfor %}
      </div>
    </section>
    {% endif %}
  </main>

  <!-- ===== FOOTER + dock mobilny ===== -->
  <footer class="site-footer" role="contentinfo">
    <div class="container footer-grid" id="footer-columns">
      <div>
        <strong>{{ (company and company[0].name) or 'Kras-Trans' }}</strong><br>
        {% if company and company[0].streetAddress %}{{ company[0].streetAddress }}{% endif %}
        {% if company and company[0].postalCode %}, {{ company[0].postalCode }}{% endif %}
        {% if company and company[0].addressLocality %} {{ company[0].addressLocality }}{% endif %}<br>
        <a href="tel:{{ (company and company[0].telephone) or '+48793927467' }}">{{ (company and company[0].telephone) or '+48 793 927 467' }}</a>
      </div>
      <nav class="footer-links" aria-label="{{ strings.nav_footer or 'Nawigacja w stopce' }}">
        {% set nav_items = (nav or []) | selectattr('lang','equalto',_lang) | list %}
        {% for item in nav_items[:8] %}<a href="{{ item.href }}">{{ item.label }}</a>{% endfor %}
      </nav>
    </div>
    <div class="container"><small>¬© {{ (now or '')[:4] or '' }} {{ (company and company[0].name) or 'Kras-Trans' }}</small></div>
  </footer>

  <nav class="bottom-bar" aria-label="Skr√≥ty">
    <a href="#kontakt">üì¶<span>{{ strings.short_quote or 'Wycena' }}</span></a>
    <a href="#faq">‚ùì<span>FAQ</span></a>
    <a href="tel:{{ (company and company[0].telephone) or '+48793927467' }}">üìû<span>{{ strings.short_call or 'Telefon' }}</span></a>
    <a href="#hero">‚¨ÜÔ∏è<span>{{ strings.short_top or 'G√≥ra' }}</span></a>
    <a href="/{{ _lang }}/transport-miedzynarodowy/">üåç<span>EU</span></a>
  </nav>

  {# ------ JSON-LD: Organization + WebPage + Breadcrumbs (+ FAQ je≈õli jest) ------ #}
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@graph":[
      {
        "@type":"Organization",
        "name":"{{ (company and company[0].name) or 'Kras-Trans' }}",
        {% if company and company[0].url %}"url":"{{ company[0].url }}",{% endif %}
        {% if company and company[0].telephone %}"telephone":"{{ company[0].telephone }}",{% endif %}
        "logo":"{{ _site }}/assets/media/og-default.webp"
      },
      {
        "@type":"WebPage",
        "name":"{{ _title }}",
        "url":"{{ _canon }}",
        "inLanguage":"{{ _lang }}"
      },
      {
        "@type":"BreadcrumbList",
        "itemListElement":[
          { "@type":"ListItem","position":1,"name":"Home","item":"{{ _site }}/{{ _lang }}/" }
          {% if page.parentSlug %}, { "@type":"ListItem","position":2,"name":"{{ page.parentSlug }}","item":"{{ _site }}/{{ _lang }}/{{ page.parentSlug }}/" }{% endif %},
          { "@type":"ListItem","position":{{ 3 if page.parentSlug else 2 }},"name":"{{ page.h1 or page.title or page.seo_title or _slug }}","item":"{{ _canon }}" }
        ]
      }
      {% if page_faq|length %},
      {
        "@type":"FAQPage",
        "mainEntity":[
          {% for f in page_faq -%}
          { "@type":"Question","name":"{{ f.question }}","acceptedAnswer":{"@type":"Answer","text":"{{ f.answer }}"} }{{ "," if not loop.last else "" }}
          {%- endfor %}
        ]
      }
      {% endif %}
    ]
  }
  </script>

  {# ------ JS: global + menu-builder ------ #}
  <script src="/assets/js/kras-global.js" defer></script>

  {# Je≈õli w Arkuszu brak zak≈Çadki Nav dla danego jƒôzyka, u≈ºyj prostego configu KRAS_NAV: #}
  {% set _nav_items = (nav or []) | selectattr('lang','equalto',_lang) | list %}
  {% if _nav_items|length == 0 %}
  <script>
    window.KRAS_NAV = {
      items: [
        { label:"Oferta", href:"/{{ _lang }}/#oferta" },
        { label:"Us≈Çugi", href:"/{{ _lang }}/uslugi/", children:[
          { label:"Express 3,5 t", href:"/{{ _lang }}/transport-ekspresowy/" },
          { label:"Paletowy",     href:"/{{ _lang }}/transport-paletowy/" }
        ]},
        { label:"FAQ",     href:"/{{ _lang }}/#faq" },
        { label:"Kontakt", href:"/{{ _lang }}/#kontakt" }
      ],
      langs: [
        {% for alt in (pages or []) | selectattr('slugKey','equalto',samekey) | list -%}
        { code:"{{ (alt.lang or 'pl')|lower }}", label:"{{ (alt.lang or 'PL')|upper }}", href:"/{{ (alt.lang or 'pl')|lower }}/{{ alt.slug or '' }}/" }{{ "," if not loop.last else "" }}
        {%- endfor %}
      ]
    };
  </script>
  {% endif %}

  <script src="/assets/js/menu-builder.js" defer></script>

  {# ------ GA4 po onload (mniejszy wp≈Çyw na LCP/INP) ------ #}
  {% if GA_ID %}
  <script>
    window.addEventListener('load', function(){
      var s=document.createElement('script');
      s.src='https://www.googletagmanager.com/gtag/js?id={{ GA_ID }}';
      s.async=true; document.head.appendChild(s);
      window.dataLayer=window.dataLayer||[]; function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config','{{ GA_ID }}',{'transport_type':'beacon','anonymize_ip':true});
    }, { once:true });
  </script>
  {% endif %}

  {# ------ Leniwe dociƒÖganie wid≈ºet√≥w do [data-embed-src] (je≈õli nie masz tego w kras-global.js) ------ #}
  <script>
    (function(){
      const els = document.querySelectorAll('[data-embed-src]');
      if(!('IntersectionObserver' in window) || !els.length) return;
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(async e=>{
          if(!e.isIntersecting) return;
          const box = e.target; io.unobserve(box);
          const url = box.getAttribute('data-embed-src');
          try{
            const res = await fetch(url, { credentials:'omit' });
            const html = await res.text();
            // prosta dezynfekcja: usuwamy <script>
            const tmp = document.createElement('div'); tmp.innerHTML = html;
            tmp.querySelectorAll('script').forEach(s=>s.remove());
            box.innerHTML = tmp.innerHTML;
          }catch(_){ box.innerHTML = '<p class="muted">Nie uda≈Ço siƒô wczytaƒá modu≈Çu.</p>'; }
        });
      }, { rootMargin:'200px 0px' });
      els.forEach(el=>io.observe(el));
    })();
  </script>
</body>
</html>
