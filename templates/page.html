{% set BRAND = (company[0].name if company is defined and company|length>0 and company[0].name else 'Kras-Trans') %}
{% set _slug  = (page.slugKey or page.slug or 'home') if page is defined else 'home' %}
{% set _lang  = (page.lang    or 'pl')   if page is defined else 'pl' %}
{% set PAGES  = pages  if pages  is defined else [] %}
{% set BLOCKS = blocks if blocks is defined else [] %}
{% set HREF   = hreflang if hreflang is defined else {} %}

{# i18n fallback, gdy strings nie nadejdą #}
{% set I18N = {
  'pl': {'offers_title':'Nasza oferta','routes_title':'Kierunki','hero_cta_primary':'Wyceń transport teraz','hero_cta_secondary':'Zadzwoń','faq_title':'FAQ'},
  'en': {'offers_title':'Our offer','routes_title':'Routes','hero_cta_primary':'Get a quote','hero_cta_secondary':'Call','faq_title':'FAQ'},
  'de': {'offers_title':'Unser Angebot','routes_title':'Routen','hero_cta_primary':'Angebot anfordern','hero_cta_secondary':'Anrufen','faq_title':'FAQ'},
  'fr': {'offers_title':'Notre offre','routes_title':'Itinéraires','hero_cta_primary':'Demander un devis','hero_cta_secondary':'Appeler','faq_title':'FAQ'},
  'it': {'offers_title':'La nostra offerta','routes_title':'Rotte','hero_cta_primary':'Richiedi preventivo','hero_cta_secondary':'Chiama','faq_title':'FAQ'},
  'ru': {'offers_title':'Наше предложение','routes_title':'Направления','hero_cta_primary':'Запросить расчёт','hero_cta_secondary':'Позвонить','faq_title':'FAQ'},
  'ua': {'offers_title':'Наша пропозиція','routes_title':'Напрямки','hero_cta_primary':'Кошторис','hero_cta_secondary':'Дзвонити','faq_title':'FAQ'}
} %}
{% set STR = (strings if strings is defined and strings else I18N[_lang]) %}

{# kanoniczny #}
{% set _canon = page.canonical_path or '/' ~ _lang ~ '/' ~ (_slug != 'home' and (_slug ~ '/') or '') %}

{# link do wersji językowych: najpierw z hreflang, w innym razie /{lang}/{slug}/ #}
{% macro url_of(slugkey, lang) -%}
  {%- set map = HREF[slugkey] if HREF and (slugkey in HREF) else {} -%}
  {%- if map and (lang in map) -%}{{ map[lang] }}
  {%- else -%}
    {%- set p = PAGES|selectattr('slugKey','equalto',slugkey)|selectattr('lang','equalto',lang)|first -%}
    {%- set the_slug = (p.slug if p and p.slug else slugkey) -%}
    /{{ lang }}/{{ the_slug }}/
  {%- endif -%}
{%- endmacro %}

<!doctype html>
<html lang="{{ _lang }}" class="no-motion">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#0b1220">
  <title>{{ page.seo_title or page.title or BRAND }}</title>
  <meta name="description" content="{{ page.meta_desc or page.lead or '' }}">
  <link rel="canonical" href="{{ _canon }}">

  {# hreflang (x-default = EN/PL fallback) #}
  {% set _hl = HREF[_slug] if HREF and (_slug in HREF) else {} %}
  {% for L,href in (_hl or {}).items() %}
    <link rel="alternate" hreflang="{{ 'uk' if L=='ua' else L }}" href="{{ href }}">
  {% endfor %}
  {% if _hl and (_hl.en or _hl.pl) %}
    <link rel="alternate" hreflang="x-default" href="{{ _hl.en or _hl.pl }}">
  {% endif %}

  <link rel="preload" href="/assets/fonts/InterVariable.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="stylesheet" href="/assets/css/app.css">
  <style>
    /* delikatne minimum, resztę masz w /assets/css/app.css */
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    .hero{padding:56px 0}
    .hero-wrap{display:grid;grid-template-columns:1.05fr 1fr;gap:32px}
    .hero .claim{display:inline-block;font-size:.8rem;letter-spacing:.1em;opacity:.8;margin-bottom:10px}
    .hero h1{font-size:clamp(32px,4.2vw,54px);line-height:1.05;margin:.2em 0 .3em}
    .hero .lead{color:var(--muted);max-width:62ch}
    .hero-cta{display:flex;gap:12px;margin-top:16px}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:14px;border:1px solid var(--edge,#2a3448)}
    .btn.primary{background:linear-gradient(180deg,#28a3ff,#0077ff);color:#fff;border:none}
    .section{padding:56px 0}
    .card-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px}
    @media(min-width:700px){.card{grid-column:span 6}}
    @media(min-width:1024px){.card{grid-column:span 4}}
    .prose p{margin:.6em 0}
    .rail{display:grid;grid-auto-flow:column;grid-auto-columns:80%;gap:14px;padding:4px;overflow-x:auto;scroll-snap-type:x mandatory}
    .rail > a{scroll-snap-align:center}
    .offer-card{display:flex;flex-direction:column;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:18px;overflow:hidden}
    .offer-card img{width:100%;height:auto;display:block}
    .offer-card__title{font-weight:700;padding:12px 14px 4px}
    .offer-card__desc{opacity:.8;padding:0 14px 14px}
    /* FAQ */
    details{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:14px}
    details+details{margin-top:10px}
    summary{cursor:pointer;font-weight:600}
  </style>
</head>
<body>
{% include '_partials/header.html' %}
  <main id="main" role="main">
    … (treść z Twojego `page.html`) …
  </main>
  {% include '_partials/footer.html' %}

  
  <main id="main" role="main">
    <!-- ============ HERO ============ -->
    <section class="hero" id="hero">
      <div class="container hero-wrap">
        <div class="hero-copy">
          {% if page.claim %}<span class="claim">{{ page.claim }}</span>{% endif %}
          <h1>{{ page.h1 or page.title }}</h1>
          {% if page.lead %}<p class="lead" data-md>{{ page.lead }}</p>{% endif %}
          <p class="hero-cta">
            <a class="btn primary" href="#quote">{{ STR.hero_cta_primary }}</a>
            <a class="btn" href="tel:{{ (company and company[0].telephone) or '+48793927467' }}">{{ STR.hero_cta_secondary }}</a>
          </p>
        </div>
        {% if page.hero_video %}
          <video class="hero-media" muted loop playsinline preload="none" poster="{{ page.hero_poster or '' }}" width="1280" height="720">
            <source src="{{ page.hero_video }}" type="video/mp4">
          </video>
        {% elif page.hero_image %}
          <img class="hero-media" src="{{ page.hero_image }}" alt="{{ page.hero_alt or page.h1 }}" width="1280" height="720" loading="eager">
        {% endif %}
      </div>
    </section>

    {# ============ OFERTA (kafelki) – z blocks.block == 'offer' lub fallback: PAGES[type='service'] ============ #}
    {% set _offers = BLOCKS
        |selectattr('lang','equalto',_lang)
        |selectattr('page','equalto',_slug)
        |selectattr('block','equalto','offer')
        |list %}
    {% if not _offers|length %}
      {% set _offers = PAGES|selectattr('type','equalto','service')|selectattr('lang','equalto',_lang)|list %}
    {% endif %}
    {% if _offers|length %}
    <section class="section" id="offers">
      <div class="container"><h2>{{ STR.offers_title }}</h2></div>
      <div class="container">
        <div class="rail">
          {% for it in _offers|sort(attribute='order') %}
            {% set url = it.href or it.url or '/' ~ _lang ~ '/' ~ (it.slug or '') ~ '/' %}
            <a class="offer-card" href="{{ url }}">
              {% if it.media %}<img src="{{ it.media }}" alt="" width="{{ it.img_w or 1280 }}" height="{{ it.img_h or 720 }}" loading="lazy">{% endif %}
              <span class="offer-card__title">{{ it.h1 or it.title or it.seo_title or it.slug }}</span>
              {% if it.lead or it.desc or it.meta_desc %}
                <span class="offer-card__desc" data-md>{{ it.lead or it.desc or it.meta_desc }}</span>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

    {# ============ BLOKI STRONY (automatyczne sekcje wg block) ============ #}
    {% set _page_blocks = BLOCKS
        |selectattr('lang','equalto',_lang)
        |selectattr('page','equalto',_slug)
        |selectattr('enabled','ne',False)
        |sort(attribute='order')
        |list %}
    {% if _page_blocks|length %}
      {# grupowanie wg pola "block" (np. 'why','how','fleet','license','faq' ...) #}
      {% for kind, items in _page_blocks|groupby('block') %}
        {% set _title = (items[0].section_title or items[0].title or kind|capitalize) if items and (items[0] is defined) else kind|capitalize %}
        {% if 'faq' in (kind|string) %}
          <section class="section" id="{{ kind }}">
            <div class="container"><h2>{{ _title }}</h2></div>
            <div class="container">
              {% for f in items %}
                {% if f.title %}<details><summary>{{ f.title }}</summary>{% else %}<details>{% endif %}
                  {% if f.lead %}<p data-md>{{ f.lead }}</p>{% endif %}
                  {% if f.body_md %}<div class="prose" data-md>{{ f.body_md }}</div>{% endif %}
                </details>
              {% endfor %}
            </div>
          </section>
        {% else %}
          <section class="section" id="{{ kind }}">
            <div class="container"><h2>{{ _title }}</h2></div>
            <div class="container card-grid">
              {% for b in items %}
                <article class="card">
                  {% if b.title %}<h3>{{ b.title }}</h3>{% endif %}
                  {% if b.lead %}<p class="muted" data-md>{{ b.lead }}</p>{% endif %}
                  {% if b.body_md %}<div class="prose" data-md>{{ b.body_md }}</div>{% endif %}
                  {% if b.href and b.cta_label %}<p><a class="btn" href="{{ b.href }}">{{ b.cta_label }}</a></p>{% endif %}
                </article>
              {% endfor %}
            </div>
          </section>
        {% endif %}
      {% endfor %}
    {% endif %}

    {# ============ KIERUNKI (mapa) – pokaż na home albo gdy page.show_map == True ============ #}
    {% if _slug == 'home' or page.show_map %}
    <section class="section" id="kierunki">
      <div class="container"><h2>{{ STR.routes_title }}</h2></div>
      <div class="container">
        <div class="iframe-wrap" style="aspect-ratio:16/9">
          <iframe class="routes-map" title="Mapa kierunków" loading="lazy"
                  src="/assets/media/mapa-kierunkow-kras-trans.html"
                  sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer"></iframe>
        </div>
      </div>
    </section>
    {% endif %}

    {# ============ DODATKOWA TREŚĆ Z page.body_md (opcjonalnie) ============ #}
    {% if page.body_md %}
    <section class="section" id="content">
      <div class="container">
        <div class="prose" data-md>{{ page.body_md }}</div>
      </div>
    </section>
    {% endif %}

    {# ============ ANCHOR DO WYCENY (do podpięcia formularza lub stopki) ============ #}
    <div id="quote"></div>

  </main>

  <!-- ============ FORMATOWANIE TEKSTU / MD (lightweight) ============ -->
  <script>
  (function(){
    function toHtml(md){
      if(!md) return '';
      let s = (md+'').replace(/\r\n/g,'\n').trim();

      // listy punktowane: linie zaczynające się od "-" lub "•"
      if (/^(\s*[-•]\s.+\n?)+$/m.test(s) || s.includes('\n- ') || s.includes('\n• ')) {
        const items = s.split('\n').map(l=>l.replace(/^\s*[-•]\s?/,'').trim()).filter(Boolean);
        return '<ul><li>'+items.join('</li><li>')+'</li></ul>';
      }

      // listy numerowane 1) 2) ...
      if (/^\s*\d+\)\s/m.test(s)) {
        const items = s.split(/\n+/).map(l=>l.replace(/^\s*\d+\)\s*/,'').trim()).filter(Boolean);
        return '<ol><li>'+items.join('</li><li>')+'</li></ol>';
      }

      // akapity + nowe linie
      s = s
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/\n{2,}/g,'</p><p>')
        .replace(/\n/g,'<br>');
      return '<p>'+s+'</p>';
    }

    document.querySelectorAll('[data-md]').forEach(el=>{
      const raw = el.textContent;
      el.innerHTML = toHtml(raw);
    });
  })();
  </script>
</body>
</html>
