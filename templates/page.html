{# ========= PAGE TEMPLATE (FULL REWRITE) ========= #}
{# — bezpieczne set-y (nic nie wywali się przy brakach w CMS) — #}
{% set BRAND   = (company[0].name if company is defined and company|length > 0 and company[0].name else 'Kras-Trans') %}
{% set _slug   = page.slugKey or page.slug or 'home' %}
{% set _lang   = page.lang or 'pl' %}

{# — fallback i18n (gdy strings puste) — #}
{% set I18N = {
  'pl': {'offers_title':'Nasza oferta','routes_title':'Kierunki','hero_cta_primary':'Wyceń transport teraz','hero_cta_secondary':'Zadzwoń 24/7','menu_services':'Usługi','menu_biz':'Dla firm','menu_resources':'Zasoby','menu_about':'O nas','menu_fleet':'Flota','menu_blog':'Blog','menu_contact':'Kontakt','dock_home':'Start','dock_menu':'Menu','licenses_label':'Licencje & ubezpieczenia'},
  'en': {'offers_title':'Our offer','routes_title':'Routes','hero_cta_primary':'Get a quote','hero_cta_secondary':'Call 24/7','menu_services':'Services','menu_biz':'For business','menu_resources':'Resources','menu_about':'About','menu_fleet':'Fleet','menu_blog':'Blog','menu_contact':'Contact','dock_home':'Home','dock_menu':'Menu','licenses_label':'Licenses & insurance'},
  'de': {'offers_title':'Unser Angebot','routes_title':'Routen','hero_cta_primary':'Angebot anfordern','hero_cta_secondary':'Anrufen 24/7','menu_services':'Leistungen','menu_biz':'Für Firmen','menu_resources':'Ressourcen','menu_about':'Über uns','menu_fleet':'Flotte','menu_blog':'Blog','menu_contact':'Kontakt','dock_home':'Home','dock_menu':'Menü','licenses_label':'Lizenzen & Versicherung'},
  'fr': {'offers_title':'Notre offre','routes_title':'Itinéraires','hero_cta_primary':'Demander un devis','hero_cta_secondary':'Appeler 24/7','menu_services':'Services','menu_biz':'Pour les entreprises','menu_resources':'Ressources','menu_about':'À propos','menu_fleet':'Flotte','menu_blog':'Blog','menu_contact':'Contact','dock_home':'Accueil','dock_menu':'Menu','licenses_label':'Licences & assurances'},
  'it': {'offers_title':'La nostra offerta','routes_title':'Rotte','hero_cta_primary':'Richiedi preventivo','hero_cta_secondary':'Chiama 24/7','menu_services':'Servizi','menu_biz':'Per aziende','menu_resources':'Risorse','menu_about':'Chi siamo','menu_fleet':'Flotta','menu_blog':'Blog','menu_contact':'Contatto','dock_home':'Home','dock_menu':'Menu','licenses_label':'Licenze e assicurazioni'},
  'ru': {'offers_title':'Наше предложение','routes_title':'Направления','hero_cta_primary':'Запросить расчёт','hero_cta_secondary':'Позвонить 24/7','menu_services':'Услуги','menu_biz':'Для бизнеса','menu_resources':'Ресурсы','menu_about':'О компании','menu_fleet':'Парк','menu_blog':'Блог','menu_contact':'Контакты','dock_home':'Главная','dock_menu':'Меню','licenses_label':'Лицензии и страхование'},
  'ua': {'offers_title':'Наша пропозиція','routes_title':'Напрямки','hero_cta_primary':'Кошторис','hero_cta_secondary':'Дзвонити 24/7','menu_services':'Послуги','menu_biz':'Для бізнесу','menu_resources':'Ресурси','menu_about':'Про нас','menu_fleet':'Автопарк','menu_blog':'Блог','menu_contact':'Контакт','dock_home':'Головна','dock_menu':'Меню','licenses_label':'Ліцензії та страхування'}
} %}
{% set STR     = (strings if strings is defined and strings else I18N[_lang]) %}
{% set _canon  = page.canonical_path or '/' ~ _lang ~ '/' ~ (_slug != 'home' and (_slug ~ '/') or '') %}
{% set COMPANY = (company if company is defined else []) %}
{% set PHONE   = (COMPANY and COMPANY[0].telephone) or '+48793927467' %}
{% set PAGES   = (pages   if pages   is defined else []) %}
{% set BLOCKS  = (blocks  if blocks  is defined else []) %}
{% set HREFLANG= (hreflang if hreflang is defined else {}) %}
{% set NAV_CFG = (nav_cfg if nav_cfg is defined else {}) %}

{# — pomocnicze: zbuduj URL danej podstrony po slugKey i języku — #}
{% macro url_of(slugkey, lang) -%}
  {%- set map = HREFLANG[slugkey] if HREFLANG and (slugkey in HREFLANG) else {} -%}
  {%- if map and (lang in map) -%}{{ map[lang] }}
  {%- else -%}
    {%- set p = PAGES|selectattr('slugKey','equalto',slugkey)|selectattr('lang','equalto',lang)|first -%}
    {%- set the_slug = (p.slug if p and p.slug else slugkey) -%}
    /{{ lang }}/{{ the_slug }}/
  {%- endif -%}
{%- endmacro %}

<!doctype html>
<html lang="{{ _lang }}" class="no-motion">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#0a0f16">

  <title>{{ page.seo_title or page.title or BRAND }}</title>
  <meta name="description" content="{{ page.meta_desc or page.lead or '' }}">

  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ page.og_title or page.seo_title or page.title or BRAND }}">
  <meta property="og:description" content="{{ page.og_desc or page.meta_desc or page.lead }}">
  <meta property="og:image" content="{{ page.og_image or '/assets/media/og-default.jpg' }}">
  <meta property="og:url" content="{{ _canon }}">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ page.seo_title or page.title or BRAND }}">
  <meta name="twitter:description" content="{{ page.meta_desc or page.lead }}">
  <meta name="twitter:image" content="{{ page.og_image or '/assets/media/og-default.jpg' }}">
  <link rel="canonical" href="{{ _canon }}">

  {# — HREFLANG (jeśli podano w CMS) — #}
  {% set _map = HREFLANG[_slug] if HREFLANG and (_slug in HREFLANG) else {} %}
  {% for L, H in _map.items() %}
    <link rel="alternate" hreflang="{{ 'uk' if L=='ua' else L }}" href="{{ H }}">
  {% endfor %}
  {% if _map.en or _map.pl %}
    <link rel="alternate" hreflang="x-default" href="{{ _map.en or _map.pl }}">
  {% endif %}

    {# — jeden bundel z CSS — #}
    <link rel="stylesheet" href="/assets/css/app.css">
  <noscript><style>.nojs-hide{display:none!important}</style></noscript>
</head>

<body>
    <!-- ===== BACKGROUNDS (Canvas/gradient) – aktywowane przez JS ===== -->
    <div id="bg-grid" aria-hidden="true"></div>
    <canvas id="bg-canvas" aria-hidden="true" hidden></canvas>

    {% include "_partials/header.html" %}

    <!-- ============ HERO ============ -->
    <main id="main" class="content" role="main">
    <section class="hero" id="hero">
      <div class="container hero-wrap">
        <div class="hero-copy">
          <span class="claim">{{ page.claim or 'Kompleksowe usługi transportowe' }}</span>
          <h1>{{ page.h1 or page.title or BRAND }}</h1>
          {% if page.lead %}<p class="lead" data-md>{{ page.lead }}</p>{% endif %}
          <p class="hero-cta">
            <a class="btn primary" href="#quote">{{ STR.hero_cta_primary }}</a>
            <a class="btn" href="tel:{{ PHONE }}">{{ STR.hero_cta_secondary }}</a>
          </p>
        </div>
        {% if page.hero_video %}
          <video class="hero-media" muted loop playsinline preload="none" poster="{{ page.hero_poster or '' }}" width="1680" height="720">
            <source src="{{ page.hero_video }}" type="video/mp4">
          </video>
        {% elif page.hero_image %}
          <img class="hero-media" src="{{ page.hero_image }}" alt="{{ page.hero_alt or page.h1 }}" width="1680" height="720" loading="eager" fetchpriority="high">
        {% endif %}
      </div>
    </section>

    <!-- ============ OFFERS (3D tiles mobile / grid desktop) ============ -->
    {% set offers = BLOCKS|selectattr('block','equalto','offer')|selectattr('lang','equalto',_lang)|selectattr('page','equalto',_slug)|list %}
    {% if not offers|length %}
      {% set offers = PAGES|selectattr('type','equalto','service')|selectattr('lang','equalto',_lang)|list %}
    {% endif %}

    {% if offers|length %}
    <section class="section split-hero split-hero--narrow" id="offer-reveal" data-section="offers" aria-label="{{ STR.offers_title }}">
      <div class="split-hero__sticky">
        <div class="split-hero__stack">
          <div class="split-hero__title" aria-hidden="true">
            <span class="title-half title-left">{{ STR.offers_title }}</span>
            <span class="title-half title-right">{{ STR.offers_title }}</span>
          </div>
          <h2 class="visually-hidden">{{ STR.offers_title }}</h2>

          <div class="split-hero__rail" id="offer-rail" role="list" aria-label="{{ STR.offers_title }}">
            {% for it in offers|sort(attribute='order') %}
              {% set url = it.href or it.url or '/' ~ _lang ~ '/' ~ (it.slug or it.slugKey or '') ~ '/' %}
              <a role="listitem" class="offer-card" href="{{ url }}">
                {% if it.media %}<img src="{{ it.media }}" alt="" width="{{ it.img_w or 1280 }}" height="{{ it.img_h or 720 }}" loading="lazy" decoding="async">{% endif %}
                <span class="offer-card__title">{{ it.h1 or it.title or it.seo_title or it.slug }}</span>
                {% if it.lead or it.desc or it.meta_desc %}<span class="offer-card__desc" data-md>{{ it.lead or it.desc or it.meta_desc }}</span>{% endif %}
              </a>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="sep sep--morph" data-morph="wave-2" aria-hidden="true"></div>
    </section>
    {% endif %}

    <!-- ============ PAGE BLOCKS (from Blocks sheet) ============ -->
    {% set page_blocks = BLOCKS|selectattr('lang','equalto',_lang)|selectattr('page','equalto',_slug)|selectattr('enabled','ne',False)|list %}
    {% if page_blocks|length %}
    <section class="section" id="blocks">
      <div class="container grid">
        {% for b in page_blocks|sort(attribute='order') %}
        <article class="card">
          {% if b.title %}<h3>{{ b.title }}</h3>{% endif %}
          {% if b.lead %}<p class="muted" data-md>{{ b.lead }}</p>{% endif %}
          {% if b.body_md %}<div class="prose" data-md>{{ b.body_md }}</div>{% endif %}
          {% if b.href and b.cta_label %}
            <p><a class="btn" href="{{ b.href }}">{{ b.cta_label }}</a></p>
          {% endif %}
        </article>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- ============ PAGE.MD (optional long content) ============ -->
    {% if page.body_md %}
    <section class="section" id="content">
      <div class="container text">
        <div class="prose" data-md>{{ page.body_md }}</div>
      </div>
    </section>
    {% endif %}

    <!-- ============ MAP / ROUTES ============ -->
    <section class="section" id="kierunki" data-section="kierunki">
      <div class="container text"><h2>{{ STR.routes_title }}</h2></div>
      <div class="container">
        <div class="iframe-wrap" style="aspect-ratio:16/9">
          <iframe class="routes-map" title="Mapa kierunków"
                  loading="lazy"
                  src="/assets/media/mapa-kierunkow-kras-trans.html"
                  sandbox="allow-scripts allow-same-origin"
                  referrerpolicy="no-referrer"></iframe>
        </div>
      </div>
    </section>
    </main>

    {% include "_partials/footer.html" %}

  <!-- ============ JSON-LD (Organization fallback) ============ -->
  {% if page.structured_data %}
    <script type="application/ld+json">{{ page.structured_data|safe }}</script>
  {% else %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "{{ BRAND }}",
      "url": "{{ _canon }}",
      "telephone": "{{ PHONE }}",
      "logo": "/assets/media/og-default.jpg"
    }
    </script>
  {% endif %}

  <!-- ============ JS bundle ============ -->
  <script>
    window.KT = {
      lang: "{{ _lang }}",
      slugKey: "{{ _slug }}",
      phone: "{{ PHONE }}",
      nav: {{ NAV_CFG|tojson }}
    };
  </script>
  <script src="/assets/js/app.js" defer></script></body>
  </html>
