<!doctype html>
<html lang="{{ (page.lang if page is defined and page.lang is defined else 'pl') }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#0b0f17">

  {# — Tytuł/opis (bezpiecznie z fallbackami) — #}
  {% set _title = (page.seo_title if page is defined and page.seo_title else (page.title if page is defined and page.title else (page.h1 if page is defined and page.h1 else 'Kras-Trans'))) %}
  {% set _desc  = (page.meta_desc if page is defined and page.meta_desc else (page.description if page is defined and page.description else (page.lead if page is defined and page.lead else 'Transport i spedycja — Polska & UE'))) %}
  <title>{{ _title }}</title>
  <meta name="description" content="{{ _desc }}">

  {# — Canonical + hreflang — #}
  {% set _lang = (page.lang if page is defined and page.lang else 'pl') %}
  {% set _slug = (page.slug if page is defined and page.slug else '') %}
  {% set _path = '/' ~ _lang ~ '/' ~ (_slug ~ '/' if _slug else '') %}
  {% set _site = (SITE_URL if SITE_URL is defined and SITE_URL else (site_url if site_url is defined and site_url else 'https://kras-trans.com')) %}
  {% set _canon = _site ~ _path %}
  <link rel="canonical" href="{{ _canon }}">
  {% set samekey = (page.slugKey if page is defined and page.slugKey else (page.slug if page is defined and page.slug else 'home')) %}
  {% set _pages = (pages if pages is defined else []) %}
  {% for alt in _pages | selectattr('slugKey','equalto',samekey) | list %}
    {% set _altpath = '/' ~ (alt.lang or 'pl') ~ '/' ~ ((alt.slug or '') ~ '/' if alt.slug else '') %}
    <link rel="alternate" hreflang="{{ (alt.lang or 'pl')|lower }}" href="{{ _site ~ _altpath }}">
  {% endfor %}
  <link rel="alternate" hreflang="x-default" href="{{ _canon }}">

  {# — OpenGraph / Twitter — #}
  {% set ogimg = (page.og_image if page is defined and page.og_image else (page.hero_image if page is defined and page.hero_image else 'assets/media/og-default.webp')) %}
  {% set _og = ogimg or 'assets/media/og-default.webp' %}
  {% if _og and _og[0]=='/' %}{% set _og = _og[1:] %}{% endif %}
  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ _title }}">
  <meta property="og:description" content="{{ _desc }}">
  <meta property="og:url" content="{{ _canon }}">
  <meta property="og:image" content="{{ _site ~ '/' ~ _og }}">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ _title }}">
  <meta name="twitter:description" content="{{ _desc }}">
  <meta name="twitter:image" content="{{ _site ~ '/' ~ _og }}">

  {# — GSC (opcjonalnie) — #}
  {% if GSC_VERIFICATION is defined and GSC_VERIFICATION %}<meta name="google-site-verification" content="{{ GSC_VERIFICATION }}">{% endif %}

  {# — Performance: fonts & CSS — #}
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/InterVariable.woff2" crossorigin>
  <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/InterVariable-Italic.woff2" crossorigin>
  <link rel="stylesheet" href="/assets/css/kras-global.css">

  <style>
    .visually-hidden{position:absolute!important;clip:rect(1px,1px,1px,1px);clip-path:inset(50%);height:1px;width:1px;overflow:hidden;white-space:nowrap}
  </style>
</head>
<body>
  <!-- tło: siatka + canvas „patyczki” (bez obrazków) -->
  <div id="bg-grid" aria-hidden="true"></div>
  <canvas id="bg-canvas" aria-hidden="true"></canvas>

  {# ================= HEADER (sticky) ================= #}
  {% set _company = (company if company is defined and company else []) %}
  {% set brand_name = (_company[0].name if _company and _company[0].name else (strings.brand if strings is defined and strings.brand is defined else 'Kras-Trans')) %}
  <header class="site-header" role="banner">
    <div class="container header-grid">
      <a class="brand" href="/">{{ brand_name }}</a>

      {# — NAV: z arkusza, fallback jeśli brak — #}
      {% set _nav = (nav if nav is defined else []) %}
      {% set nav_items = _nav | selectattr('lang','equalto',_lang) | list %}
      {% if nav_items|length == 0 %}
        {% set nav_items = [
          {'label':'Oferta','href':'/' ~ _lang ~ '/#oferta'},
          {'label':'Kierunki','href':'/' ~ _lang ~ '/kierunki/'},
          {'label':'Blog','href':'/' ~ _lang ~ '/blog/'},
          {'label':'Kontakt','href':'/' ~ _lang ~ '/#kontakt'}
        ] %}
      {% endif %}

      <nav id="site-nav" class="nav" aria-label="{{ (strings.nav_main if strings is defined and strings.nav_main is defined else 'Główna nawigacja') }}">
        <ul class="nav-list">
          {% for item in nav_items %}
            <li><a href="{{ item.href }}">{{ item.label }}</a></li>
          {% endfor %}
        </ul>
        <ul class="nav-langs" aria-label="{{ (strings.nav_langs if strings is defined and strings.nav_langs is defined else 'Języki') }}">
          {% for alt in _pages | selectattr('slugKey','equalto',samekey) | list %}
            {% set _altpath = '/' ~ (alt.lang or 'pl') ~ '/' ~ ((alt.slug or '') ~ '/' if alt.slug else '') %}
            <li><a href="{{ _altpath }}" hreflang="{{ (alt.lang or 'pl')|lower }}">{{ (alt.lang or 'PL')|upper }}</a></li>
          {% endfor %}
        </ul>
      </nav>

      <div class="header-actions">
        <button id="theme-toggle" class="icon-btn theme-toggle" type="button" aria-label="{{ (strings.theme_toggle if strings is defined and strings.theme_toggle is defined else 'Zmień motyw') }}" aria-pressed="false" title="Motyw">
          <span class="sun" aria-hidden="true"></span>
          <span class="moon" aria-hidden="true"></span>
          <span class="paper" aria-hidden="true"></span>
        </button>
        {% set tel = (_company[0].telephone if _company and _company[0].telephone else '+48793927467') %}
        <a class="btn primary btn--shine" href="tel:{{ tel }}">{{ (strings.cta_call if strings is defined and strings.cta_call is defined else 'Zadzwoń 24/7') }}</a>
      </div>
    </div>
  </header>

  <main id="main" class="content" role="main">
    {# ================= HERO ================= #}
    <section class="hero" id="hero" aria-label="{{ (strings.hero_aria if strings is defined and strings.hero_aria is defined else 'Hero') }}">
      <div class="container hero-wrap">
        <div class="hero-copy">
          <span class="claim">{{ (page.claim if page is defined and page.claim else (strings.claim if strings is defined and strings.claim is defined else 'Kompleksowe usługi transportowe')) }}</span>
          <h1>{{ (page.h1 if page is defined and page.h1 else (page.title if page is defined and page.title else 'Transport — Polska & Europa')) }}</h1>
          {% if page is defined and page.lead %}<p>{{ page.lead }}</p>{% endif %}
          <p>
            <a class="btn primary" href="#kontakt">{{ (strings.hero_cta_primary if strings is defined and strings.hero_cta_primary is defined else 'Wycena 15 min') }}</a>
            <a class="btn" href="tel:{{ tel }}">{{ (strings.hero_cta_secondary if strings is defined and strings.hero_cta_secondary is defined else 'Zadzwoń') }}</a>
          </p>

          {# Kroki (mikro-onboarding) — chmurka nad CTA #}
          <div class="card" style="margin-top:10px;max-width:520px">
            <div class="pad">
              <strong>{{ (strings.steps_title if strings is defined and strings.steps_title is defined else 'Jak to działa?') }}</strong>
              <ol style="margin:.6rem 0 0 1.2rem">
                <li>Kliknij „<a href="#kontakt">Wyceń transport teraz</a>”.</li>
                <li>Wpisz trasę i dane ładunku.</li>
                <li>Wyślij – oddzwonimy i potwierdzimy odbiór.</li>
              </ol>
              <small style="display:block;margin-top:.6rem;color:var(--muted)">Darmowa wycena • Bez ukrytych opłat • Szybki kontakt po wysłaniu formularza</small>
            </div>
          </div>
        </div>

        {% if page is defined and page.hero_video %}
          <video class="hero-media" muted loop playsinline preload="none"
                 poster="{{ page.hero_poster or 'assets/media/hero.webp' }}"
                 width="1680" height="720">
            <source src="{{ page.hero_video }}" type="video/mp4">
          </video>
        {% elif page is defined and page.hero_image %}
          <img class="hero-media" src="{{ page.hero_image }}"
               alt="{{ page.hero_alt or page.h1 or page.title }}"
               width="1680" height="720" fetchpriority="high">
        {% else %}
          <img class="hero-media" src="/assets/media/hero.webp"
               alt="{{ (page.h1 if page is defined and page.h1 else _title) }}" width="1680" height="720" fetchpriority="high">
        {% endif %}
      </div>
    </section>

    {# ================= OFERTA (kafelki; mobilnie scroll w bok) ================= #}
    {% set _blocks  = (blocks  if blocks  is defined else []) %}
    {% set _services_pages = _pages | selectattr('type','equalto','service') | selectattr('lang','equalto',_lang) | list %}
    {% set offers_blocks = _blocks | selectattr('block','equalto','offer') | selectattr('lang','equalto',_lang) | selectattr('page','equalto',samekey) | list %}
    {% set offers = offers_blocks if offers_blocks|length else _services_pages %}

    <section class="section --line" id="oferta" data-section="offers" aria-label="{{ (strings.offers_aria if strings is defined and strings.offers_aria is defined else 'Nasza oferta') }}">
      <div class="container text">
        <h2>{{ (strings.offers_title if strings is defined and strings.offers_title is defined else 'Nasza oferta') }}</h2>
        {% if strings is defined and strings.offers_desc is defined and strings.offers_desc %}<p>{{ strings.offers_desc }}</p>{% endif %}
      </div>

      {% if offers|length %}
        {% set offers_sorted = offers|sort(attribute='order') %}
        <div class="container cards tilt-cards cards--wrap cards--scroll" data-equalize="true" aria-label="{{ (strings.offers_list if strings is defined and strings.offers_list is defined else 'Lista usług') }}">
          {% for it in offers_sorted %}
            {% if loop.index0 < 8 %}
              {% set url = it.href or it.url or ('/' ~ _lang ~ '/' ~ ((it.slug or '') ~ '/' if it.slug else '')) %}
              <article class="card offer">
                <div class="pad">
                  <h3>{{ it.title or it.h1 or it.seo_title or it.slug }}</h3>
                  {% if it.desc or it.lead or it.meta_desc %}
                    <p>{{ it.desc or it.lead or it.meta_desc }}</p>
                  {% endif %}
                  {% if url %}
                    <a class="btn" href="{{ url }}">{{ it.cta or it.cta_text or (strings.offer_cta if strings is defined and strings.offer_cta is defined else 'Sprawdź termin i cenę') }}</a>
                  {% endif %}
                </div>
              </article>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <div class="sep sep--morph" data-morph="wave-2" aria-hidden="true"></div>
    </section>

    {# ================= KIERUNKI / MAPA ================= #}
    <section class="section" id="kierunki">
      <div class="container text">
        <h2>{{ (strings.routes_title if strings is defined and strings.routes_title is defined else 'Kierunki i specjalizacje') }}</h2>
        <p>{{ (strings.routes_desc if strings is defined and strings.routes_desc is defined else 'Polska, Niemcy, Czechy, Słowacja, Beneluks, Włochy, Francja, Hiszpania.') }}</p>
      </div>
      <div class="container">
        <iframe
          src="/assets/media/mapa-kierunkow-kras-trans.html"
          loading="lazy" decoding="async"
          width="100%" height="420" style="border:0;display:block;border-radius:12px;background:transparent"
          referrerpolicy="no-referrer"
          sandbox="allow-same-origin allow-scripts">
        </iframe>
      </div>
    </section>

    {# ================= BLOG (podgląd 6 wpisów) ================= #}
    {% set _blog = (blog if blog is defined else []) %}
    {% set _blog_lang = _blog | selectattr('lang','equalto',_lang) | list %}
    {% if _blog_lang|length %}
      {% set _blog_sorted = _blog_lang | sort(attribute='order') %}
      <section class="section alt --dots" id="blog">
        <div class="container text"><h2>{{ (strings.blog_title if strings is defined and strings.blog_title is defined else 'Poradniki i aktualności') }}</h2></div>
        <div class="container cards cards--wrap cards--scroll" data-equalize="true">
          {% for p in _blog_sorted %}
            {% if loop.index0 < 6 %}
              {% set href = '/' ~ _lang ~ '/' ~ ((p.slug or '') ~ '/' if p.slug else '') %}
              <article class="card">
                <div class="pad">
                  <h3><a href="{{ href }}">{{ p.h1 or p.title or p.seo_title }}</a></h3>
                  {% if p.meta_desc %}<p>{{ p.meta_desc }}</p>{% endif %}
                  <a class="btn" href="{{ href }}">{{ (strings.read_more if strings is defined and strings.read_more is defined else 'Czytaj dalej') }}</a>
                </div>
              </article>
            {% endif %}
          {% endfor %}
        </div>
      </section>
    {% endif %}

    {# ================= FAQ (dla tej strony) ================= #}
    {% set _faq_all = (faq if faq is defined else []) %}
    {% set page_faq = _faq_all | selectattr('lang','equalto',_lang) | selectattr('page','equalto',samekey) | list %}
    {% if page_faq|length %}
      <section class="section --dots" id="faq" aria-label="{{ (strings.faq_aria if strings is defined and strings.faq_aria is defined else 'Najczęstsze pytania') }}">
        <div class="container text"><h2>{{ (strings.faq_title if strings is defined and strings.faq_title is defined else 'FAQ — najczęstsze pytania') }}</h2></div>
        <div class="container cards cards--wrap" data-equalize="true">
          {% for f in page_faq %}
            <details class="card"><div class="pad">
              <summary><strong>{{ f.question }}</strong></summary>
              <p>{{ f.answer }}</p>
            </div></details>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    {# ================= KONTAKT ================= #}
    <section class="section" id="kontakt" data-section="contact" aria-label="{{ (strings.contact_aria if strings is defined and strings.contact_aria is defined else 'Kontakt i wycena') }}">
      <div class="container text">
        <h2>{{ (strings.contact_title if strings is defined and strings.contact_title is defined else 'Skontaktuj się z nami') }}</h2>
        {% if strings is defined and strings.contact_desc is defined and strings.contact_desc %}<p>{{ strings.contact_desc }}</p>{% endif %}
      </div>

      <div class="container">
        <form class="card" method="post" action="{{ (LEAD_ACTION if LEAD_ACTION is defined and LEAD_ACTION else '/lead') }}" data-ajax="true">
          <div class="pad">
            <div class="cards cards--wrap" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));">
              <label class="card"><div class="pad"><input name="name" type="text" placeholder="{{ (strings.form_name if strings is defined and strings.form_name is defined else 'Imię i nazwisko') }}" required></div></label>
              <label class="card"><div class="pad"><input name="phone" type="tel" placeholder="{{ (strings.form_phone if strings is defined and strings.form_phone is defined else 'Telefon') }}" required></div></label>
              <label class="card"><div class="pad"><input name="email" type="email" placeholder="E-mail" required></div></label>
            </div>
            <p><textarea name="message" placeholder="{{ (strings.form_message if strings is defined and strings.form_message is defined else 'Treść zapytania') }}" rows="4" style="width:100%"></textarea></p>
            <p>
              <button class="btn primary btn--progress" type="submit" data-progress>
                <span class="btn__label">{{ (strings.form_submit if strings is defined and strings.form_submit is defined else 'Wyślij') }}</span>
                <span class="btn__spinner" aria-hidden="true"></span>
                <span class="btn__check" aria-hidden="true">✓</span>
              </button>
              <a class="btn" href="tel:{{ tel }}">{{ (strings.cta_call_short if strings is defined and strings.cta_call_short is defined else 'Zadzwoń') }}</a>
            </p>
          </div>
        </form>
      </div>
    </section>

    {# ================= POWIĄZANE ================= #}
    {% set related = _pages
      | selectattr('lang','equalto',_lang)
      | selectattr('parentSlug','equalto', (page.parentSlug if page is defined and page.parentSlug else None))
      | rejectattr('slugKey','equalto',samekey)
      | list %}
    {% if related|length %}
      <section class="section --line" id="related">
        <div class="container text"><h2>{{ (strings.related_title if strings is defined and strings.related_title is defined else 'Powiązane strony') }}</h2></div>
        <div class="container cards cards--wrap">
          {% set _rel_sorted = related|sort(attribute='order') %}
          {% for r in _rel_sorted %}
            {% if loop.index0 < 6 %}
              <article class="card"><div class="pad">
                <h3><a href="/{{ _lang }}/{{ r.slug }}/">{{ r.h1 or r.title or r.seo_title }}</a></h3>
                {% if r.meta_desc %}<p>{{ r.meta_desc }}</p>{% endif %}
              </div></article>
            {% endif %}
          {% endfor %}
        </div>
      </section>
    {% endif %}
  </main>

  {# ================= FOOTER + dock mobilny ================= #}
  <footer class="site-footer" role="contentinfo">
    <div class="container footer-grid" id="footer-columns">
      <div>
        <strong>{{ brand_name }}</strong><br>
        {% if _company and _company[0].streetAddress %}{{ _company[0].streetAddress }}{% endif %}
        {% if _company and _company[0].postalCode %}, {{ _company[0].postalCode }}{% endif %}
        {% if _company and _company[0].addressLocality %} {{ _company[0].addressLocality }}{% endif %}<br>
        <a href="tel:{{ tel }}">{{ tel }}</a>
      </div>
      <nav class="footer-links" aria-label="{{ (strings.nav_footer if strings is defined and strings.nav_footer is defined else 'Nawigacja w stopce') }}">
        {% for item in nav_items %}
          {% if loop.index0 < 8 %}<a href="{{ item.href }}">{{ item.label }}</a>{% endif %}
        {% endfor %}
      </nav>
    </div>
    <div class="container"><small>© {{ (updated if updated is defined else '')[:4] }} {{ brand_name }}</small></div>
  </footer>

  <nav class="bottom-bar" aria-label="Skróty">
    <a href="#kontakt">📦<span>{{ (strings.short_quote if strings is defined and strings.short_quote is defined else 'Wycena') }}</span></a>
    <a href="#faq">❓<span>FAQ</span></a>
    <a href="tel:{{ tel }}">📞<span>{{ (strings.short_call if strings is defined and strings.short_call is defined else 'Telefon') }}</span></a>
    <a href="#hero">⬆️<span>{{ (strings.short_top if strings is defined and strings.short_top is defined else 'Góra') }}</span></a>
    <a href="/{{ _lang }}/transport-miedzynarodowy/">🌍<span>EU</span></a>
  </nav>

  {# — JSON-LD podstawowy — #}
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@graph":[
      {
        "@type":"Organization",
        "name":"{{ brand_name }}",
        "logo":"{{ _site }}/assets/media/og-default.webp"{% if _company and _company[0].url %},
        "url":"{{ _company[0].url }}"{% endif %}{% if tel %},
        "telephone":"{{ tel }}"{% endif %}
      },
      {
        "@type":"WebPage",
        "name":"{{ _title }}",
        "url":"{{ _canon }}",
        "inLanguage":"{{ _lang }}"
      }
    ]
  }
  </script>

  {# — JS: global + menu-builder — #}
  <script src="/assets/js/kras-global.js" defer></script>
  <script src="/assets/js/menu-builder.js" defer></script>

  {# — GA4 po onload (aby LCP/INP nie cierpiały) — #}
  {% if GA_ID is defined and GA_ID %}
  <script>
    window.addEventListener('load',function(){
      var s=document.createElement('script');
      s.src='https://www.googletagmanager.com/gtag/js?id={{ GA_ID }}'; s.async=true; document.head.appendChild(s);
      window.dataLayer=window.dataLayer||[]; function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date()); gtag('config','{{ GA_ID }}',{'transport_type':'beacon','anonymize_ip':true});
    }, {once:true});
  </script>
  {% endif %}
</body>
</html>
