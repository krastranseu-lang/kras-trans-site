<!doctype html>
<html lang="{{ page.lang or site.defaultLang or 'pl' }}" class="no-js" data-color-scheme="light dark">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="referrer" content="{{ site.privacy.referrerPolicy or 'strict-origin-when-cross-origin' }}" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="color-scheme" content="light dark" />

  <title>{{ page.seo_title or page.title }}</title>
  <meta name="description" content="{{ page.meta_desc }}" />
  {% if page.noindex %}<meta name="robots" content="noindex,follow" />{% else %}<meta name="robots" content="index,follow" />{% endif %}
  <link rel="canonical" href="{{ page.canonical or canonical }}" />

  {# --- HREFLANG (z buildera) --- #}
  {% if alternates %}
    {% for code, href in alternates.items() %}
      <link rel="alternate" hreflang="{{ code }}" href="{{ href }}" />
    {% endfor %}
  {% endif %}
  {% if hreflang %}
    {% for code, href in hreflang.items() %}
      <link rel="alternate" hreflang="{{ code }}" href="{{ href }}" />
    {% endfor %}
  {% endif %}

  {# --- Weryfikacja GSC --- #}
  {% if gsc_verification %}<meta name="google-site-verification" content="{{ gsc_verification }}" />{% endif %}

  {# --- Open Graph / Twitter --- #}
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="{{ site.brand }}" />
  <meta property="og:url" content="{{ page.canonical or canonical }}" />
  <meta property="og:title" content="{{ page.seo_title or page.title }}" />
  <meta property="og:description" content="{{ page.meta_desc }}" />
  <meta property="og:image" content="{{ site.url or site.base_url }}{{ page.og_image }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ page.seo_title or page.title }}" />
  <meta name="twitter:description" content="{{ page.meta_desc }}" />
  <meta name="twitter:image" content="{{ site.url or site.base_url }}{{ page.og_image }}" />

  {# --- Ikony / Manifest --- #}
  <link rel="icon" href="/assets/img/favicon.ico" sizes="any" />
  <link rel="icon" href="/assets/img/icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="/assets/img/apple-touch-icon.png" />
  <link rel="manifest" href="/assets/manifest.webmanifest" />

  {# --- Preconnecty tylko gdy potrzebne --- #}
  {% if 'script.google.com' in (cms_endpoint or '') %}
    <link rel="preconnect" href="https://script.google.com" crossorigin />
  {% endif %}
  {% if ga_id %}
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
  {% endif %}

  {# --- LCP image preload (preferowany ręcznie: page.lcp_image) --- #}
  {% if page.lcp_image %}
    <link rel="preload" as="image" fetchpriority="high"
          {% if page.lcp_image.srcset %}imagesrcset="{{ page.lcp_image.srcset }}"{% endif %}
          href="{{ page.lcp_image.src or page.lcp_image }}" />
  {% endif %}

  {# --- Preloady/CSS z pages.yml → assets --- #}
  {% if assets.preload %}
    {% for p in assets.preload %}
      <link rel="preload" as="{{ p.as }}" href="{{ p.href }}"{% if p.fetchpriority %} fetchpriority="{{ p.fetchpriority }}"{% endif %} />
    {% endfor %}
  {% endif %}
  {% if assets.css %}
    {% for href in assets.css %}
      <link rel="stylesheet" href="{{ href }}" />
    {% endfor %}
  {% endif %}

  {# --- Self-host fonts (Inter Variable) + critical a11y CSS (≤~2KB) --- #}
  <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/InterVariable.woff2" crossorigin>
  <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/InterVariable-Italic.woff2" crossorigin>
  <style>
    @font-face{font-family:'InterVariable';src:url('/assets/fonts/InterVariable.woff2') format('woff2');font-weight:100 900;font-style:normal;font-display:swap}
    @font-face{font-family:'InterVariable';src:url('/assets/fonts/InterVariable-Italic.woff2') format('woff2');font-weight:100 900;font-style:italic;font-display:swap}
    :root{--brand:#0ea5e9;--focus:#22C3A6;--fg:#0b1020}
    html{scroll-behavior:smooth}
    body{margin:0;font-family:'InterVariable',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Liberation Sans',sans-serif;color:#1f2937;background:#fff}
    .wrap{max-width:1120px;margin:0 auto;padding:0 16px}
    .skip-link{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip-link:focus{left:12px;top:8px;width:auto;height:auto;background:#111;color:#fff;padding:8px 12px;border-radius:12px;z-index:100}
    :focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .site-header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(180%) blur(12px);background:rgba(255,255,255,.72);border-bottom:1px solid rgba(0,0,0,.06)}
    @media (prefers-color-scheme: dark){body{background:#0b1020;color:#e5e7eb}.site-header{background:rgba(15,23,42,.62);border-color:rgba(255,255,255,.08)}}
  </style>

  {# --- Endpoint CMS dla skryptów klienckich --- #}
  <meta name="cms-endpoint" content="{{ cms_endpoint }}" />

  <script>document.documentElement.classList.remove('no-js');</script>
</head>
<body>
  <a class="skip-link" href="#main">{{ (i18n.skip_to_content if i18n else '') or 'Skip to content' }}</a>

  {# --- Header partial --- #}
  {% if header_path %}
    {% include header_path %}
  {% else %}
    {% include "__partials/header.html" %}
  {% endif %}

  <main id="main" tabindex="-1" role="main">
    {% block content %}{% endblock %}
  </main>

  {# --- Footer partial --- #}
  {% if footer_path %}
    {% include footer_path %}
  {% else %}
    {% include "__partials/footer.html" %}
  {% endif %}

  {# --- JSON-LD (Organization, Website, Breadcrumb, per-typ) z buildera --- #}
  {% if jsonld %}{{ jsonld|safe }}{% endif %}

  {# --- Skrypty z pages.yml → assets.js (defer) --- #}
  {% if assets.js %}
    {% for src in assets.js %}
      <script defer src="{{ src }}"></script>
    {% endfor %}
  {% endif %}

  {# --- Loader „late JS” (>50KB): opcjonalnie assets.js_late w pages.yml --- #}
  <script>
  (function(){
    function loadLate(){
      // 1) Przenieś skrypty oznaczone data-late
      document.querySelectorAll('script[data-late]').forEach(function(s){
        var n=document.createElement('script');
        for (var i=0;i<s.attributes.length;i++){var a=s.attributes[i]; if(a.name!=='data-late') n.setAttribute(a.name,a.value);}
        n.defer = s.defer || true; s.remove(); document.body.appendChild(n);
      });
      // 2) Wczytaj JS z opcjonalnej sekcji assets.js_late (po load/idle)
      {% if assets.js_late %}
        try { var late={{ assets.js_late | tojson }}; late.forEach(function(src){ var n=document.createElement('script'); n.defer=true; n.src=src; document.body.appendChild(n); }); } catch(e){}
      {% endif %}
    }
    if('requestIdleCallback' in window){ requestIdleCallback(loadLate,{timeout:1500}); }
    else { window.addEventListener('load', loadLate); }
  })();
  </script>

  {# --- Fallback: jeśli cms.js nie podpięty w assets.js, doładuj --- #}
  <script>
    (function(){
      if(!document.querySelector('script[src*="/assets/js/cms.js"],script[data-src*="/assets/js/cms.js"]')){
        var s=document.createElement('script'); s.defer=true; s.src='/assets/js/cms.js'; document.body.appendChild(s);
      }
    })();
  </script>

  {# --- Google Analytics po idle/zgodzie (lekkie) --- #}
  {% if ga_id %}
  <script>
    (function(id){
      function loadGA(){ if(window.__gaLoaded) return; window.__gaLoaded=true;
        var s=document.createElement('script'); s.async=true; s.src='https://www.googletagmanager.com/gtag/js?id='+id; document.head.appendChild(s);
        window.dataLayer=window.dataLayer||[]; function gtag(){dataLayer.push(arguments);} window.gtag=gtag; gtag('js', new Date()); gtag('config', id, {anonymize_ip:true});
      }
      if(window.ktConsentGranted===true){ loadGA(); }
      else if('requestIdleCallback' in window){ requestIdleCallback(loadGA,{timeout:2000}); }
      else { window.addEventListener('load', loadGA); }
    })('{{ ga_id }}');
  </script>
  {% endif %}

  {# --- Noscript: minimalny layout, bez CLS --- #}
  <noscript><style>.site-header{position:sticky}.reel{scroll-snap-type:none}</style></noscript>
</body>
</html>
