{# expects in context:
   page.lang -> current lang (fallback 'pl')
   nav       -> list[ {lang,label,href,parent,order,col,enabled} ]
   company   -> company data (for phone etc.)  # optional
#}
{% set LANG = page.lang or 'pl' %}
{% set nav_lang = nav | selectattr('lang','equalto', LANG) | list %}
{% set top = nav_lang | selectattr('parent','equalto','') | sort(attribute='order') | list %}
{% set has_children = nav_lang | rejectattr('parent','equalto','') | map(attribute='parent') | list %}

<header class="kt-header" data-theme="auto">
  <div class="kt-container">
    <!-- Logo -->
    <a class="kt-logo" href="/{{LANG}}/">
      <img src="/assets/media/logo-transport-kras-trans.svg" alt="Kras-Trans" width="132" height="36" />
    </a>

    <!-- Desktop nav -->
    <nav class="kt-nav" aria-label="Main">
      <ul class="kt-nav__list">
        {% for item in top %}
          {% set kids = nav_lang | selectattr('parent','equalto', item.label) | sort(attribute='order') | list %}
          {% if kids|length %}
            <li class="kt-nav__item has-mega">
              <button class="kt-nav__link" aria-expanded="false" aria-haspopup="true" data-mega="#mega-{{ loop.index }}">
                <span>{{ item.label }}</span>
                <svg class="kt-caret" width="12" height="12" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
              </button>
              <div class="kt-mega" id="mega-{{ loop.index }}" role="dialog" aria-label="{{ item.label }}">
                <div class="kt-mega__grid">
                  {% for col, group in kids|groupby('col') %}
                    <ul class="kt-mega__col">
                      {% for link in group|sort(attribute='order') %}
                        <li><a href="{{ link.href }}">{{ link.label }}</a></li>
                      {% endfor %}
                    </ul>
                  {% endfor %}
                </div>
              </div>
            </li>
          {% else %}
            <li class="kt-nav__item">
              <a class="kt-nav__link" href="{{ item.href }}"><span>{{ item.label }}</span></a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </nav>

    <!-- Right side: language, theme, CTA -->
    <div class="kt-actions">
      <div class="kt-lang">
        {% set LANGS = ['pl','en','de','fr','it','ru','ua'] %}
        <button class="kt-lang__btn" aria-expanded="false" aria-haspopup="true">
          <span class="kt-lang__current">{{ LANG|upper }}</span>
          <svg class="kt-caret" width="12" height="12" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
        </button>
        <ul class="kt-lang__list" role="menu">
          {% for L in LANGS %}
            <li role="none"><a role="menuitem" href="/{{L}}/{{ page.slug or '' }}"{% if L==LANG %} aria-current="true"{% endif %}>{{ L|upper }}</a></li>
          {% endfor %}
        </ul>
      </div>

      <button class="kt-theme" id="kt-theme" aria-label="Toggle theme">
        <svg class="sun" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path d="M12 4V2m0 20v-2m8-8h2M2 12h2m13.657-6.343l1.414-1.414M4.929 19.071l1.414-1.414M18.071 19.071l-1.414-1.414M6.343 6.343L4.929 4.929" stroke="currentColor" stroke-width="2" fill="none"/>
          <circle cx="12" cy="12" r="4" fill="currentColor"/>
        </svg>
      </button>

      <a class="kt-cta" href="/{{LANG}}/wycena/">{{ 'Wycena' if LANG=='pl' else 'Quote' }}</a>

      <!-- Mobile burger -->
      <button class="kt-burger" aria-label="Menu" aria-expanded="false" aria-controls="kt-mobile">
        <span></span><span></span><span></span>
      </button>
    </div>
  </div>

  <!-- Mobile drawer -->
  <div class="kt-mobile" id="kt-mobile" aria-hidden="true">
    <div class="kt-mobile__inner">
      <div class="kt-mobile__top">
        <a class="kt-logo" href="/{{LANG}}/">
          <img src="/assets/media/logo-transport-kras-trans.svg" alt="Kras-Trans" width="132" height="36" />
        </a>
        <a class="kt-cta" href="/{{LANG}}/wycena/">{{ 'Wycena' if LANG=='pl' else 'Quote' }}</a>
      </div>
      <nav class="kt-mobile__nav" aria-label="Mobile">
        <ul class="kt-mobile__list">
          {% for item in top %}
            {% set kids = nav_lang | selectattr('parent','equalto', item.label) | sort(attribute='order') | list %}
            {% if kids|length %}
              <li class="kt-mobile__item">
                <details>
                  <summary>{{ item.label }}</summary>
                  <div class="kt-mobile__cols">
                    {% for col, group in kids|groupby('col') %}
                      <ul>
                        {% for link in group|sort(attribute='order') %}
                          <li><a href="{{ link.href }}">{{ link.label }}</a></li>
                        {% endfor %}
                      </ul>
                    {% endfor %}
                  </div>
                </details>
              </li>
            {% else %}
              <li class="kt-mobile__item"><a href="{{ item.href }}">{{ item.label }}</a></li>
            {% endif %}
          {% endfor %}
        </ul>
      </nav>
      <div class="kt-mobile__utils">
        <div class="kt-lang kt-lang--mobile">
          <div class="kt-lang__row">
            <span>{{ 'Język' if LANG=='pl' else 'Language' }}</span>
            <div class="kt-lang__pills">
              {% for L in ['pl','en','de','fr','it','ru','ua'] %}
                <a class="pill{% if L==LANG %} is-active{% endif %}" href="/{{L}}/{{ page.slug or '' }}">{{ L|upper }}</a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% if company and company[0] and company[0].telephone %}
          <a class="kt-call" href="tel:{{ company[0].telephone }}">{{ 'Zadzwoń 24/7' if LANG=='pl' else 'Call 24/7' }}</a>
        {% endif %}
      </div>
    </div>
  </div>
</header>
