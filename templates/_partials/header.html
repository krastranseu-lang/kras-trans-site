<!-- templates/header.html -->
<!-- Global Header (Kras-Trans) — glassmorphism, i18n, mega-menu, mobile dock -->
<link rel="preconnect" href="https://script.google.com" crossorigin>
<link rel="preload" href="/assets/css/header.css" as="style">
<link rel="preload" href="/assets/media/logo.png" as="image" imagesizes="36px" imagesrcset="/assets/media/logo.png 1x, /assets/media/logo@2x.png 2x">
<link rel="preload" href="/assets/flags/pl.svg" as="image" type="image/svg+xml">

<!-- Anti-FOUC: theme + i18n redirect (runs ASAP) -->
<script>
(function () {
  try {
    const d = document.documentElement;
    // THEME
    const lsKey = 'kt:theme';
    const saved = localStorage.getItem(lsKey);
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    d.setAttribute('data-theme', (saved === 'light' || saved === 'dark') ? saved : (prefersDark ? 'dark' : 'light'));
    // I18N redirect (if path missing /xx/ where xx ∈ locales)
    var LOCALES = ['pl','en','de','fr','it','ru','ua'];
    var p = location.pathname.replace(/^\/+/, '').split('/');
    var lang = p[0];
    if (!LOCALES.includes(lang)) {
      var def = 'pl';
      // do not redirect assets or special paths
      var first = (p[0] || '').toLowerCase();
      if (!first || !/^assets|static|api|cms|admin$/.test(first)) {
        var rest = p.join('/');
        var target = '/' + def + '/' + (rest ? rest : '');
        target = target.replace(/\/+$/,'/') // ensure trailing slash
        var url = target + location.search + location.hash;
        location.replace(url);
      }
    }
  } catch (e) {}
})();
</script>

<!-- Optional critical CSS inline (keep tiny) -->
<style>
/* == assets/css/header.critical.css (inline) == */
:root{
  --kt-bg-glass-light: rgba(255,255,255,.78);
  --kt-bg-glass-dark: rgba(12,16,24,.55);
  --kt-text-light:#0D1B2A; --kt-text-dark:#EAF2FF; --kt-muted-light:#5A6475; --kt-muted-dark:#A4B1C5;
  --kt-accent-1:#19E3C1; --kt-accent-2:#00BFA5;
  --kt-shadow: 0 6px 28px rgba(0,0,0,.16);
  --kt-max: 1240px; --kt-h:64px; --kt-r:14px;
}
html[data-theme="light"]{color-scheme:light;}
html[data-theme="dark"]{color-scheme:dark;}
#site-header{position:sticky;top:0;z-index:50;background:transparent}
.kt-topbar{height:var(--kt-h); display:flex; align-items:center; justify-content:space-between; gap:12px;
  backdrop-filter:saturate(140%) blur(12px); -webkit-backdrop-filter:saturate(140%) blur(12px);
  background:var(--kt-bg, var(--kt-bg-glass-light)); box-shadow:var(--kt-shadow)}
html[data-theme="light"] .kt-topbar{--kt-bg:var(--kt-bg-glass-light); color:var(--kt-text-light)}
html[data-theme="dark"] .kt-topbar{--kt-bg:var(--kt-bg-glass-dark); color:var(--kt-text-dark)}
.kt-wrap{width:100%; max-width:var(--kt-max); margin:0 auto; padding:0 16px; display:flex; align-items:center; gap:16px}
.kt-brand img{height:36px;width:auto; display:block}
@media (max-width:1100px){ .kt-brand img{height:32px} }
@media (max-width:860px){ .kt-brand img{height:28px} }
.kt-actions{display:flex; align-items:center; gap:10px}
.kt-burger{display:none; width:44px;height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:transparent}
@media (max-width:860px){ .kt-burger{display:inline-flex; align-items:center; justify-content:center}}
.kt-nav{display:flex; align-items:center; gap:18px}
@media (max-width:1100px){ .kt-nav{gap:12px} }
@media (max-width:860px){ .kt-nav{display:none} }
.kt-cta{padding:.6rem .9rem; border-radius:12px; background:var(--kt-accent-1); color:#001318; font-weight:650}
#ktMega{position:fixed; left:0; right:0; top:var(--megaTop, 64px); transform:translateZ(0); will-change:opacity, transform; opacity:0; pointer-events:none}
#ktMega.open{opacity:1; pointer-events:auto}
#ktDock{display:none}
@media (max-width:860px){
  #ktDock{position:sticky; bottom:0; z-index:55; display:block}
  .kt-dock{position:fixed; left:0; right:0; bottom:0; background:var(--kt-bg, rgba(12,16,24,.75)); backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px); padding:8px 10px; display:grid; grid-template-columns:repeat(4,1fr); gap:8px; box-shadow:0 -10px 18px rgba(0,0,0,.18)}
  .kt-fab{position:fixed; right:14px; bottom:72px; width:56px;height:56px;border-radius:16px;background:var(--kt-accent-1); color:#001318; display:grid; place-items:center; box-shadow:0 8px 24px rgba(25,227,193,.45)}
}
.kt-visually-hidden{position:absolute!important; width:1px;height:1px;margin:-1px;border:0;padding:0;clip:rect(0 0 0 0);overflow:hidden}
</style>

<header id="site-header"
  role="banner"
  data-api="https://script.google.com/macros/s/<DEPLOY_ID>/exec?key=<API_KEY>"
  data-default-lang="pl"
  data-logo-src="/assets/media/logo.png"
  aria-label="Kras-Trans global header">

  <div class="kt-topbar">
    <div class="kt-wrap">
      <!-- Brand -->
      <a class="kt-brand" id="ktBrand" href="/" aria-label="Kras-Trans">
        <img id="ktLogo" src="/assets/media/logo.png" alt="Kras-Trans" width="128" height="36" decoding="async">
      </a>

      <!-- Primary nav -->
      <nav id="ktNav" class="kt-nav" role="navigation" aria-label="Primary">
        <!-- Fallback items will be injected instantly by JS -->
      </nav>

      <!-- Actions: lang, theme, CTA -->
      <div class="kt-actions">
        <div class="kt-lang">
          <button id="ktLangBtn" class="kt-btn" aria-haspopup="listbox" aria-expanded="false" aria-label="Change language">
            <img id="ktLangFlag" src="/assets/flags/pl.svg" alt="PL" width="20" height="20">
          </button>
          <ul id="ktLangList" class="kt-lang-list" role="listbox" aria-label="Languages" hidden>
            <!-- injected -->
          </ul>
        </div>

        <button id="ktThemeBtn" class="kt-btn" aria-pressed="false" aria-label="Toggle theme">
          <!-- icon via CSS -->
          <span class="kt-visually-hidden">Theme</span>
        </button>

        <a id="ktCTA" class="kt-cta" href="/pl/wycena/" data-i18n="cta_quote_primary">Wycena transportu</a>

        <button id="ktBurger" class="kt-burger" aria-label="Open menu" aria-controls="ktMobile" aria-expanded="false">
          <!-- burger icon via CSS -->
          <span class="kt-visually-hidden">Menu</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Mega dock -->
  <div id="ktMega" aria-hidden="true">
    <div id="ktMegaInner" class="kt-wrap" role="region" aria-label="Expanded menu panel">
      <!-- dynamic -->
    </div>
  </div>

  <!-- Mobile drawer -->
  <aside id="ktMobile" class="kt-mobile" aria-hidden="true" aria-label="Mobile menu" hidden>
    <div class="kt-mobile-backdrop" data-close="mobile"></div>
    <div class="kt-mobile-panel" role="dialog" aria-modal="true" aria-labelledby="ktMobileTitle">
      <div class="kt-mobile-head">
        <h2 id="ktMobileTitle">Menu</h2>
        <button id="ktMobileClose" class="kt-btn" aria-label="Close menu" data-close="mobile">✕</button>
      </div>
      <nav id="ktMobileNav" class="kt-mobile-nav" aria-label="Mobile primary">
        <!-- injected -->
      </nav>
    </div>
  </aside>

  <!-- Bottom dock (mobile) -->
  <div id="ktDock" aria-hidden="false">
    <nav class="kt-dock" aria-label="Quick actions">
      <!-- injected -->
    </nav>
    <button id="ktDockFab" class="kt-fab" aria-label="Open menu">☰</button>
  </div>
</header>

<!-- Main header script (deferred) -->
<script id="ktHeaderScript"
  src="/assets/js/header.js"
  defer
  data-api="https://script.google.com/macros/s/<DEPLOY_ID>/exec?key=<API_KEY>"
  data-default-lang="pl">
</script>

<!-- Normal stylesheet -->
<link rel="stylesheet" href="/assets/css/header.css">
