<!-- ======================= KRAS-TRANS â€¢ HEADER (GLASS + MEGA + LANGS + THEME) =======================
     Static-first (bundle_{lang}.json) + SWR z GAS
     Mega-menu peÅ‚nej szerokoÅ›ci (grid + blog rail)
====================================================================================================== -->
<header id="site-header"
        class="site-header"
        data-api="https://script.google.com/macros/s/AKfycbyQcsU1wSCV6NGDQm8VIAGpZkL1rArZe1UZ5tutTkjJiKZtr4MjQZcDFzte26VtRJJ2KQ/exec"
        data-key="kb6mWQJQ3hTtY0m1GQ7v2rX1pC5n9d8zA4s6L2u"
        data-static="/assets/nav"
        data-theme-sun="/assets/flags/theme-sun.svg"
        data-theme-moon="/assets/flags/theme-moon.svg"
        aria-busy="true">

  <!-- ============== CRITICAL CSS (scoped do #site-header) ============== -->
  <style>
    #site-header{--bg:rgba(255,255,255,.82);--ink:#0b1020;--ink-weak:#64748b;--line:rgba(0,0,0,.08);
      --brand:#0ea5e9;--ease:cubic-bezier(.2,.7,.2,1);--mega-h:0px}
    @media (prefers-color-scheme:dark){
      #site-header{--bg:rgba(15,23,42,.62);--ink:#e5e7eb;--ink-weak:#94a3b8;--line:rgba(255,255,255,.10)}
    }
    #site-header{position:sticky;top:0;z-index:60;background:var(--bg);
      -webkit-backdrop-filter:saturate(180%) blur(12px);backdrop-filter:saturate(180%) blur(12px);
      border-bottom:1px solid var(--line);transition:box-shadow .25s ease, background .25s ease}
    #site-header.s--shadow{box-shadow:0 8px 22px rgba(0,0,0,.08)}
    #site-header .wrap{max-width:980px;margin:0 auto;padding:0 12px 0 8px}
    @media (min-width:768px){ #site-header .wrap{padding:0 18px 0 12px} }

    .bar{display:grid;grid-template-columns:minmax(120px,170px) 1fr auto;gap:10px;align-items:center;padding:6px 0}
    #site-header a{color:inherit;text-decoration:none}
    .brand{display:inline-flex;align-items:center;gap:10px;margin-left:-4px}
    .brand__logo{height:auto;max-width:160px;width:clamp(110px,10vw,160px);transition:transform .18s ease,filter .18s ease}
    .brand:hover .brand__logo{transform:scale(1.045);filter:drop-shadow(0 6px 18px rgba(14,165,233,.28))}

    .nav__list{list-style:none;margin:0;padding:0;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .nav__list>li{position:relative}
    .nav__list>li>a,.nav__list>li>button{appearance:none;background:transparent;border:0;color:inherit;font:inherit;line-height:1;cursor:pointer;
      padding:8px 10px;border-radius:12px;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .nav__list>li:hover>a{background:rgba(0,0,0,.04)}
    @media (prefers-color-scheme:dark){ .nav__list>li:hover>a{background:rgba(255,255,255,.06)}}

    .actions{display:flex;align-items:center;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:14px;border:1px solid var(--line);
      background:#fff;font-weight:700;color:var(--ink);transition:transform .15s ease, background .2s ease}
    .btn:hover{transform:translateY(-1px)}
    @media (prefers-color-scheme:dark){ .btn{background:rgba(255,255,255,.06)}}
    .btn-primary{background:var(--brand);border-color:transparent;color:#fff}

    .langs{position:relative}
    .lang-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;border:1px solid var(--line);background:#fff}
    @media (prefers-color-scheme:dark){ .lang-btn{background:rgba(255,255,255,.06)}}
    .flag{width:18px;height:12px;border-radius:3px;border:1px solid var(--line);object-fit:cover}
    .chev{width:14px;height:14px;opacity:.7}
    .lang-dd{position:absolute;right:0;top:100%;margin-top:8px;min-width:180px;background:var(--bg);
      border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 28px rgba(10,10,20,.12);padding:6px;display:none}
    .lang-dd[aria-hidden="false"]{display:block}
    .lang-dd a{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px}
    .lang-dd a[aria-current="true"]{outline:2px solid var(--line)}
    .lang-dd a:hover{background:rgba(0,0,0,.04)}
    @media (prefers-color-scheme:dark){ .lang-dd a:hover{background:rgba(255,255,255,.06)}}

    .theme{position:relative}
    .theme-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:#fff}
    @media (prefers-color-scheme:dark){ .theme-btn{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.28)}}
    .theme-btn img{width:16px;height:16px}
    .theme-dd{position:absolute;right:0;top:100%;margin-top:8px;min-width:160px;background:var(--bg);
      border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 28px rgba(10,10,20,.12);padding:6px;display:none}
    .theme-dd[aria-hidden="false"]{display:block}
    .theme-dd button{width:100%;text-align:left;padding:8px;border:0;background:transparent;border-radius:10px;display:flex;gap:8px;align-items:center}
    .theme-dd button:hover{background:rgba(0,0,0,.04)}
    @media (prefers-color-scheme:dark){ .theme-dd button:hover{background:rgba(255,255,255,.06)}}

    .social{display:flex;gap:8px;margin-left:6px}
    .social a{display:inline-flex;padding:8px;border-radius:50%}
    .status-pill{margin-left:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      font-weight:600;color:var(--ink-weak);background:rgba(14,165,233,.08)}

    .menu-toggle{width:40px;height:40px;border-radius:12px;border:1px solid var(--line);background:transparent;position:relative;display:none}
    .menu-toggle::before,.menu-toggle::after{content:"";position:absolute;left:10px;right:10px;height:2px;background:currentColor;transition:.25s var(--ease)}
    .menu-toggle::before{top:14px}.menu-toggle::after{bottom:14px}
    .menu-toggle[aria-expanded="true"]::before{transform:translateY(6px) rotate(45deg)}
    .menu-toggle[aria-expanded="true"]::after{transform:translateY(-6px) rotate(-45deg)}

    .mega{position:absolute;left:0;right:0;top:100%;pointer-events:none;transform:translateY(-8px);opacity:0;
      transition:transform .24s var(--ease),opacity .24s var(--ease)}
    .mega[data-state="open"]{pointer-events:auto;transform:translateY(0);opacity:1}
    .has-mega>.mega-toggle[aria-expanded="true"]+.mega{pointer-events:auto;transform:translateY(0);opacity:1}
    .mega .mega__wrap{padding:12px 0 18px}
    .mega .mega__grid-wrap{display:grid;grid-template-columns:1fr minmax(260px,320px);gap:16px;align-items:start}
    .mega .mega__panels{max-height:var(--mega-h);overflow:hidden;transition:max-height .28s var(--ease)}
    .mega__section{padding:4px 0 8px}
    .mega__grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (min-width:860px){ .mega__grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (min-width:1100px){ .mega__grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .mega .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(10,10,20,.08)}
    @media (prefers-color-scheme:dark){ .mega .card{background:rgba(255,255,255,.06)}}
    .mega__aside{display:grid;gap:10px}
    .mega__aside .blog-card{display:grid;grid-template-columns:110px 1fr;gap:10px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
    @media (prefers-color-scheme:dark){ .mega__aside .blog-card{background:rgba(255,255,255,.06)}}
    .mega__aside img{width:110px;height:70px;object-fit:cover}
    .mega__aside h4{font-size:.92rem;margin:8px 8px 6px}
    .mega__aside p{font-size:.8rem;color:var(--ink-weak);margin:0 8px 8px}

    .mobile-menu{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(2px);z-index:80}
    .mobile-menu[hidden]{display:none}
    .mobile-menu__inner{position:absolute;top:0;right:0;bottom:0;width:min(420px,92vw);background:var(--bg);
      border-left:1px solid var(--line);transform:translateX(100%);transition:transform .28s var(--ease);
      display:grid;grid-template-rows:auto 1fr auto auto;gap:12px;padding:16px}
    .mobile-menu[data-open="true"] .mobile-menu__inner{transform:translateX(0)}
    .mobile-head{display:flex;align-items:center;justify-content:space-between}
    .mobile-nav__list{list-style:none;margin:0;padding:0;display:grid;gap:6px}
    .mobile-nav__list li a,.mobile-nav__list li button{
      display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-radius:12px;border:1px solid var(--line);
      background:#fff;color:inherit;text-decoration:none}
    @media (prefers-color-scheme:dark){ .mobile-nav__list li a,.mobile-nav__list li button{background:rgba(255,255,255,.06)}}
    .mobile-cta{margin-top:6px}

    .dock{position:fixed;z-index:70;left:0;right:0;bottom:0;display:none;background:var(--bg);border-top:1px solid var(--line)}
    .dock ul{list-style:none;margin:0;padding:6px 10px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .dock a{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;padding:8px;border-radius:12px}
    .dock svg{width:22px;height:22px}.dock span{font-size:.72rem}
    @media (max-width:980px){ .nav{display:none}.menu-toggle{display:inline-block}.dock{display:block}}
  </style>

  <div class="wrap bar">
    <a class="brand" id="brandLink" href="/">
      <img class="brand__logo" width="176" height="40" alt="Kras-Trans â€” transport i spedycja"
           src="/assets/media/logo-firma-transportowa-kras-trans.png" loading="eager" decoding="async">
    </a>

    <nav id="primaryNav" class="nav" role="navigation" aria-label="GÅ‚Ã³wne menu">
      <ul class="nav__list" id="navList"><li><a href="/pl/">Start</a></li></ul>
    </nav>

    <div class="actions">
      <span id="statusPill" class="status-pill" hidden>ðŸšš auto wolne</span>

      <div class="langs" id="langsWrap">
        <button id="langBtn" class="lang-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="langsDd">
          <img class="flag" id="langFlag" src="/assets/flags/pl.svg" alt="" width="18" height="12"><span id="langCode">PL</span>
          <svg class="chev" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M5.2 7.6 10 12.4l4.8-4.8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div id="langsDd" class="lang-dd" role="menu" aria-hidden="true" aria-label="WybÃ³r jÄ™zyka"></div>
      </div>

      <div class="theme" id="themeWrap">
        <button id="themeBtn" class="theme-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="themeDd">
          <img id="themeIcon" src="/assets/flags/theme-moon.svg" alt="" width="16" height="16"><span id="themeLabel">Auto</span>
        </button>
        <div id="themeDd" class="theme-dd" role="menu" aria-hidden="true" aria-label="Motyw">
          <button type="button" data-theme="auto"><img src="/assets/flags/theme-sun.svg" width="16" height="16" alt="">Auto</button>
          <button type="button" data-theme="light"><img src="/assets/flags/theme-sun.svg" width="16" height="16" alt="">Light</button>
          <button type="button" data-theme="dark"><img src="/assets/flags/theme-moon.svg" width="16" height="16" alt="">Dark</button>
        </div>
      </div>

      <div class="social" id="social">
        <a id="ig" href="https://www.instagram.com/kras_trans.express.eu?igsh=bHZkODhlazFicGt2&utm_source=qr" aria-label="Instagram" rel="noopener" target="_blank">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7Zm5 3a5 5 0 1 1 0 10 5 5 0 0 1 0-10Zm0 2.2a2.8 2.8 0 1 0 0 5.6 2.8 2.8 0 0 0 0-5.6Zm5.35-.95a1.15 1.15 0 1 1 0 2.3 1.15 1.15 0 0 1 0-2.3Z"/></svg>
        </a>
        <a id="li" href="https://www.linkedin.com/company/kras-trans" aria-label="LinkedIn" rel="noopener" target="_blank">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4.98 3.5c0 1.38-1.12 2.5-2.49 2.5A2.5 2.5 0 0 1 0 3.5 2.5 2.5 0 0 1 2.49 1c1.37 0 2.49 1.12 2.49 2.5ZM.5 8.5h4V23h-4V8.5Zm7.5 0h3.84v1.98h.05c.53-1 1.83-2.05 3.77-2.05 4.03 0 4.77 2.65 4.77 6.1V23h-4v-5.87c0-1.4-.03-3.2-1.95-3.2-1.95 0-2.25 1.52-2.25 3.1V23h-4V8.5Z"/></svg>
        </a>
        <a id="fb" href="https://www.facebook.com/share/sS2jgJPwdgvrF4az/?mibextid=LQQJ4d" aria-label="Facebook" rel="noopener" target="_blank">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07C2 17.1 5.66 21.25 10.44 22v-7.04H7.9v-2.9h2.54V9.85c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.23.2 2.23.2v2.46h-1.26c-1.24 0-1.63.77-1.63 1.56v1.87h2.78l-.44 2.9h-2.34V22C18.34 21.25 22 17.1 22 12.07Z"/></svg>
        </a>
      </div>

      <a id="cta" class="btn btn-primary" href="/pl/kontakt/">ZamÃ³w wycenÄ™</a>
      <button id="menuToggle" class="menu-toggle" aria-expanded="false" aria-controls="mobileMenu" aria-label="Menu"></button>
    </div>
  </div>

  <div id="mega" class="mega" data-state="closed" aria-hidden="true">
    <div class="mega__wrap wrap">
      <div class="mega__grid-wrap">
        <div class="mega__panels" id="megaPanels"></div>
        <aside class="mega__aside" id="megaBlog"></aside>
      </div>
    </div>
  </div>

  <div id="mobileMenu" class="mobile-menu" hidden>
    <div class="mobile-menu__inner" role="dialog" aria-modal="true" aria-label="Menu mobilne">
      <div class="mobile-head">
        <strong>Menu</strong>
        <button id="closeMobile" class="menu-toggle" aria-label="Zamknij" aria-expanded="true"></button>
      </div>
      <nav class="mobile-nav" aria-label="Nawigacja mobilna">
        <ul class="mobile-nav__list" id="mobileList"><li><a href="/pl/">Start</a></li></ul>
      </nav>
      <div class="mobile-langs" id="mobileLangs"></div>
      <a class="btn btn-primary mobile-cta" id="mobileCTA" href="/pl/kontakt/">ZamÃ³w wycenÄ™</a>
    </div>
  </div>

  <nav class="dock" aria-label="Szybkie akcje">
    <ul class="wrap">
      <li><a id="dockCall" href="tel:+48" aria-label="ZadzwoÅ„">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.8a15.1 15.1 0 0 0 6.6 6.6l2.2-2.2a1.5 1.5 0 0 1 1.6-.36c1.76.59 3.66.9 5.05.93.82.02 1.49.69 1.49 1.51V21a3 3 0 0 1-3.18 3A23 23 0 0 1 3 6.18 3 3 0 0 1 6 .99h2.81c.82 0 1.49.67 1.51 1.49.04 1.39.34 3.29.93 5.05.19.58.05 1.22-.36 1.63L8.8 10.8Z"/></svg>
        <span>Telefon</span></a></li>
      <li><a id="dockWA" href="#" aria-label="WhatsApp">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M.5 23.5 3 17.9a10 10 0 1 1 3.8 3.6L.5 23.5Zm6.7-3.8.3.2a8.3 8.3 0 1 0-2.7-2.6l.2.3-1.2 3.2 3.4-1.1Zm9.8-3.8c-.1 0-.1 0 0 0-1.3-.7-2.9-1.2-3.3-1.3-.5-.1-.9 0-1.2.5s-1.1 1.3-1.4 1.5c-.2.2-.4.2-.7.1a6.7 6.7 0 0 1-2-1.2 7.5 7.5 0 0 1-1.6-2c-.2-.4 0-.6.2-.8l.5-.6c.2-.3.2-.5 0-.8l-.8-2c-.2-.5-.5-.6-1-.5h-.8c-.3 0-.7.2-.9.4-1 1-1.1 2.6-.3 4.3.8 1.6 2.4 3.6 4.8 4.7 1.7.7 3 .9 4 .6.7-.2 1.3-.7 1.5-1.3.2-.5.2-1 .2-1.2-.1-.2-.3-.3-.6-.4Z"/></svg>
        <span>WhatsApp</span></a></li>
      <li><a id="dockQuote" href="/pl/kontakt/" class="btn-primary" aria-label="Wycena">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 6H8a2 2 0 0 0-2 2v8h2V8h13V6ZM5 10H3v10c0 1.1.9 2 2 2h12v-2H5V10Zm16 3h-8v2h8v-2Zm0 4h-8v2h8v-2Zm0-8h-8v2h8V9Z"/></svg>
        <span>Wycena</span></a></li>
      <li><a id="dockMenu" href="#mobileMenu" aria-label="Menu">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v2H3V6Zm0 5h18v2H3v-2Zm0 5h18v2H3v-2Z"/></svg>
        <span>Menu</span></a></li>
    </ul>
  </nav>

  <!-- ============== Inline JS (scoped do headera) ============== -->
  <script>
  (function(){
    const $  = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    const root = document.getElementById('site-header');
    if(!root) return;

    /* Elements */
    const navList = $('#navList'), mega = $('#mega'), megaPanels = $('#megaPanels'), megaBlog = $('#megaBlog');
    const brandLink = $('#brandLink'), statusPill = $('#statusPill'), cta = $('#cta');
    const mobile = $('#mobileMenu'), mobileList = $('#mobileList'), mobileCTA = $('#mobileCTA'), closeMob = $('#closeMobile'), toggle = $('#menuToggle');
    const dockCall = $('#dockCall'), dockWA = $('#dockWA'), dockQuote = $('#dockQuote'), dockMenu = $('#dockMenu');

    /* Langs */
    const langBtn = $('#langBtn'), langDd = $('#langsDd'), langFlag = $('#langFlag'), langCodeEl = $('#langCode'), mobileLangs = $('#mobileLangs');

    /* Theme */
    const themeBtn = $('#themeBtn'), themeDd = $('#themeDd'), themeIcon = $('#themeIcon'), themeLabel = $('#themeLabel');
    const SUN = root.dataset.themeSun || '/assets/flags/theme-sun.svg';
    const MOON = root.dataset.themeMoon || '/assets/flags/theme-moon.svg';

    /* Config */
    const LOCALES = ['pl','en','de','fr','it','ru','ua'];   // EN -> GB flaga niÅ¼ej
    const FLAG = L => `/assets/flags/${L==='en'?'gb':L}.svg`;
    const API = root.dataset.api || (window.CMS_ENDPOINT||'');
    const KEY = root.dataset.key || '';
    const STATIC = (root.dataset.static||'/assets/nav').replace(/\/+$/,'');
    const TTL = 12*60*60*1000;

    /* Lang detection + path utils */
    const currentLang = (()=> {
      const m = location.pathname.match(/^\/(pl|en|de|fr|it|ru|ua)\b/i);
      return (m?m[1].toLowerCase():'pl');
    })();
    const currentSlug = (()=> {
      const m = location.pathname.replace(/^\/(pl|en|de|fr|it|ru|ua)\//,'').replace(/\/+$/,'');
      return m;
    })();
    const slugUrl = (lang, slug)=>`/${lang}/${slug?slug+'/':''}`;

    /* Cache helpers */
    const CK = k => `kt_${k}_${currentLang}`;
    const setCache = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify({ts:Date.now(), v})) }catch(e){} };
    const getCache = k => { try{ const raw=localStorage.getItem(k); if(!raw) return null; const {ts,v}=JSON.parse(raw); return (Date.now()-ts>TTL)?null:v; }catch(e){ return null } };

    /* Shadow on scroll */
    const shadow=()=>root.classList.toggle('s--shadow', (document.documentElement.scrollTop||0) > 8);
    shadow(); window.addEventListener('scroll', shadow, {passive:true});

    /* Mega hover-intent */
    let openT=0, closeT=0;
    function closeMega(){ mega.dataset.state='closed'; mega.setAttribute('aria-hidden','true'); root.style.setProperty('--mega-h','0px');
      navList?.querySelectorAll('[aria-expanded="true"]').forEach(el=>el.setAttribute('aria-expanded','false')); }
    function openMega(id){
      const panel = megaPanels?.querySelector(`.mega__section[data-panel="${id}"], .mega__section#panel-${id}`);
      if(!panel){ closeMega(); return; }
      megaPanels.querySelectorAll('.mega__section').forEach(sec=>sec.hidden=true);
      panel.hidden=false; root.style.setProperty('--mega-h', panel.scrollHeight+'px');
      mega.dataset.state='open'; mega.setAttribute('aria-hidden','false');
    }
    function armOpen(id,trg){ clearTimeout(closeT); clearTimeout(openT);
      openT=setTimeout(()=>{ navList?.querySelectorAll('[aria-expanded="true"]').forEach(el=>el.setAttribute('aria-expanded','false'));
        trg?.setAttribute('aria-expanded','true'); openMega(id); },140); }
    function armClose(){ clearTimeout(openT); clearTimeout(closeT); closeT=setTimeout(closeMega,380); }

    navList.addEventListener('pointerenter', e=>{ const li=e.target.closest('li[data-panel]'); if(!li) return; armOpen(li.getAttribute('data-panel'), li.querySelector('a,button')); });
    navList.addEventListener('pointerleave', armClose);
    navList.addEventListener('focusin', e=>{ const li=e.target.closest('li[data-panel]'); if(!li) return; armOpen(li.getAttribute('data-panel'), li.querySelector('a,button')); });
    navList.addEventListener('focusout', armClose);
    mega.addEventListener('pointerenter', ()=>clearTimeout(closeT));
    mega.addEventListener('pointerleave', armClose);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeMega(); });

    /* Mobile drawer */
    function openDrawer(){ mobile.hidden=false; requestAnimationFrame(()=>mobile.setAttribute('data-open','true')); toggle.setAttribute('aria-expanded','true'); document.documentElement.style.overflow='hidden'; }
    function closeDrawer(){ mobile.removeAttribute('data-open'); toggle.setAttribute('aria-expanded','false'); setTimeout(()=>{ mobile.hidden=true; document.documentElement.style.overflow=''; },280); }
    toggle.addEventListener('click', ()=> (toggle.getAttribute('aria-expanded')==='true') ? closeDrawer() : openDrawer());
    closeMob.addEventListener('click', closeDrawer);
    mobile.addEventListener('click', e=>{ if(e.target===mobile) closeDrawer(); });
    dockMenu.addEventListener('click', e=>{ e.preventDefault(); openDrawer(); });

    /* THEME */
    const THEME_KEY='kt_theme';
    function applyTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'auto';
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const effectiveDark = saved==='dark' || (saved==='auto' && prefersDark);
      document.documentElement.classList.toggle('theme-dark', effectiveDark);
      themeIcon.src = effectiveDark ? SUN : MOON;
      themeLabel.textContent = saved[0].toUpperCase()+saved.slice(1);
      themeBtn.setAttribute('aria-expanded','false'); themeDd.setAttribute('aria-hidden','true');
    }
    applyTheme();
    window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
    themeBtn.addEventListener('click', ()=>{
      const exp = themeBtn.getAttribute('aria-expanded')==='true';
      themeBtn.setAttribute('aria-expanded', String(!exp));
      themeDd.setAttribute('aria-hidden', String(exp));
    });
    themeDd.addEventListener('click', e=>{
      const b = e.target.closest('button[data-theme]'); if(!b) return;
      localStorage.setItem(THEME_KEY, b.dataset.theme); applyTheme();
    });
    document.addEventListener('click', e=>{ if(!themeDd.contains(e.target) && e.target!==themeBtn) { themeDd.setAttribute('aria-hidden','true'); themeBtn.setAttribute('aria-expanded','false'); }});

    /* LANGS dropdown */
    function openLangs(open){ langBtn.setAttribute('aria-expanded', String(open)); langDd.setAttribute('aria-hidden', String(!open)); }
    langBtn.addEventListener('click', ()=>{ const exp=langBtn.getAttribute('aria-expanded')==='true'; openLangs(!exp); });
    root.addEventListener('click', e=>{ if(!$('#langsWrap').contains(e.target)) openLangs(false); });

    /* ---------- RENDERING (z cache / static / API) ---------- */

    // 1) Z LOCALSTORAGE (instant)
    (function fromCache(){
      const snap = getCache(CK('nav_bundle'));
      if(!snap) return;
      try{ renderFromSnapshot(snap); root.removeAttribute('aria-busy'); }catch(_){}
    })();

    // 2) Z BUNDLA STATYCZNEGO (instant przy 1. wizycie)
    (async function fromStatic(){
      try{
        const res = await fetch(`${STATIC}/bundle_${currentLang}.json`, {cache:'force-cache'});
        if(!res.ok) return;
        const bundle = await res.json();
        const snap = {
          primary_html: bundle.primary_html||'',
          mega_html: bundle.mega_html||'',
          langs_html: bundle.langs_html||'',
          cta: bundle.cta||null,
          status: bundle.status||null,
          social: bundle.social||null,
          routes: {}, blog:[]
        };
        renderFromSnapshot(snap);
        setCache(CK('nav_bundle'), snap);
        root.removeAttribute('aria-busy');
      }catch(_){}
    })();

    // 3) Z GAS (SWR â€“ ciche odÅ›wieÅ¼enie, dokÅ‚adne routingi jÄ™zykowe + blog)
    (async function fromAPI(){
      try{
        if(!API || !KEY) { root.removeAttribute('aria-busy'); return; }
        const url = `${API}?key=${encodeURIComponent(KEY)}&lang=${encodeURIComponent(currentLang)}`;
        const res = await fetch(url, {cache:'no-store'});
        const json = await res.json();
        const nav = json.nav_current || (json.nav && json.nav[currentLang]) || {};
        const routesMap = toRoutesMap(json.routes||[]);
        renderNav(nav, routesMap, json);
        setCache(CK('nav_bundle'), snapshot(nav, routesMap, json));
        root.removeAttribute('aria-busy');
      }catch(_){ root.removeAttribute('aria-busy'); }
    })();

    /* Helpers: routes map + reverse lookup */
    function toRoutesMap(rows){
      const map={};
      rows.forEach(r=>{
        const key = String(r.slugKey||r.SlugKey||'').trim(); if(!key) return;
        const obj={}; LOCALES.forEach(L=> obj[L]=String(r[L]||r[L?.toUpperCase()]||'').trim());
        map[key]=obj;
      });
      if(!map.home){ map.home={}; LOCALES.forEach(L=> map.home[L]=''); }
      return map;
    }
    function findSlugKey(routes, lang, slug){
      const s = String(slug||'').replace(/^\/|\/$/g,'');
      for(const key in routes){ if((routes[key][lang]||'')===s) return key; }
      return 'home';
    }

    /* Render jÄ™zykÃ³w (API) */
    function renderLangs(routes){
      const key = findSlugKey(routes, currentLang, currentSlug);
      langFlag.src = FLAG(currentLang);
      langCodeEl.textContent = currentLang.toUpperCase();
      const dd = LOCALES.map(L=>{
        const target = routes[key] && routes[key][L]!==undefined ? slugUrl(L, routes[key][L]) : `/${L}/`;
        const cur = L===currentLang ? 'true':'false';
        return `<a href="${target}" aria-current="${cur}"><img class="flag" src="${FLAG(L)}" alt="" width="18" height="12"><span>${L.toUpperCase()}</span></a>`;
      }).join('');
      langDd.innerHTML = dd;
      mobileLangs.innerHTML = `<div class="lang-dd" style="display:grid;grid-auto-rows:min-content" aria-hidden="false">${dd}</div>`;
    }

    /* BLOG rail */
    function renderBlog(list){
      if(!megaBlog) return; megaBlog.innerHTML='';
      (list||[]).slice(0,4).forEach(item=>{
        const href = item.path || (item.slug ? slugUrl(currentLang, item.slug) : '#');
        const img  = item.image || item.hero_image || item.og_image || '/assets/media/og-default.webp';
        const t    = item.title || item.h1 || 'â€”';
        const lead = item.lead || '';
        const card = document.createElement('a');
        card.className='blog-card'; card.href=href;
        card.innerHTML = `<img src="${img}" alt="" width="110" height="70" loading="lazy" decoding="async"><div><h4>${escapeHtml(t)}</h4><p>${escapeHtml(lead)}</p></div>`;
        megaBlog.appendChild(card);
      });
    }

    /* Auto mapowanie li <-> sekcje mega */
    function autoMapPanels(){
      const liNo = navList.querySelectorAll('li:not([data-panel])');
      const sections = $$('.mega__section', megaPanels);
      liNo.forEach((li,i)=>{ const sec = sections[i]; if(!sec) return; const id = sec.getAttribute('data-panel') || ('auto-'+i);
        if(!li.hasAttribute('data-panel')) li.setAttribute('data-panel', id);
        sec.setAttribute('data-panel', id); if(!sec.id) sec.id = 'panel-'+id; });
    }

    /* Render z API */
    function renderNav(nav, routes, json){
      if(nav.primary_html){ navList.innerHTML = nav.primary_html; mobileList.innerHTML = nav.primary_html; }
      if(nav.mega_html){ megaPanels.innerHTML = nav.mega_html; }
      autoMapPanels();

      if(nav.cta){
        const href = routes[nav.cta.slugKey] ? slugUrl(currentLang, routes[nav.cta.slugKey][currentLang]||'') : slugUrl(currentLang,'kontakt');
        cta.href = href; cta.textContent = nav.cta.label || 'Get a quote';
        mobileCTA.href = href; mobileCTA.textContent = cta.textContent; dockQuote.href = href;
      }
      brandLink.href = slugUrl(currentLang, (routes.home && routes.home[currentLang])||'');

      if(nav.status && nav.status.label){ statusPill.hidden=false; statusPill.textContent=nav.status.label; if(nav.status.href) statusPill.onclick=()=>location.href=nav.status.href; }
      else statusPill.hidden=true;
      if(nav.social){ $('#ig').href=nav.social.ig||$('#ig').href; $('#li').href=nav.social.li||$('#li').href; $('#fb').href=nav.social.fb||$('#fb').href; }

      const tel = (json.company && json.company[0] && (json.company[0].telephone||json.company[0].phone)) || '';
      if(tel){ dockCall.href = `tel:${tel}`; dockWA.href = `https://wa.me/${tel.replace(/\D+/g,'')}`; }

      const blogList = (json.blog_latest && Array.isArray(json.blog_latest)) ? json.blog_latest
                      : (Array.isArray(json.blog)? json.blog.filter(b=>String(b.lang||'').toLowerCase()===currentLang && (b.publish!==false)).slice(0,4) : []);
      renderBlog(blogList);

      renderLangs(routes);
    }

    /* Snapshot do cache (SWR) */
    function snapshot(nav, routes, json){
      const blogList = (json.blog_latest && Array.isArray(json.blog_latest)) ? json.blog_latest
                      : (Array.isArray(json.blog)? json.blog.filter(b=>String(b.lang||'').toLowerCase()===currentLang && (b.publish!==false)).slice(0,4) : []);
      return {
        primary_html: nav.primary_html||'',
        mega_html: nav.mega_html||'',
        langs_html: '',        // z API generujemy w locie
        cta: nav.cta||null,
        status: nav.status||null,
        social: nav.social||null,
        routes: routes,
        blog: blogList
      };
    }

    /* Render z cache / statyka (mamy juÅ¼ gotowe HTML-e jÄ™zykÃ³w) */
    function renderFromSnapshot(snap){
      if(snap.primary_html){ navList.innerHTML = snap.primary_html; mobileList.innerHTML = snap.primary_html; }
      if(snap.mega_html){ megaPanels.innerHTML = snap.mega_html; }
      autoMapPanels();

      if(snap.cta){
        const href = snap.routes && snap.routes[snap.cta.slugKey]
          ? slugUrl(currentLang, snap.routes[snap.cta.slugKey][currentLang]||'')
          : slugUrl(currentLang,'kontakt');
        cta.href = href; cta.textContent = snap.cta.label || 'Get a quote';
        mobileCTA.href = href; mobileCTA.textContent = cta.textContent; dockQuote.href = href;
      }
      brandLink.href = snap.routes && snap.routes.home ? slugUrl(currentLang, snap.routes.home[currentLang]||'') : `/${currentLang}/`;

      if(snap.status && snap.status.label){ statusPill.hidden=false; statusPill.textContent=snap.status.label; if(snap.status.href) statusPill.onclick=()=>location.href=snap.status.href; }
      else statusPill.hidden=true;
      if(snap.social){ $('#ig').href=snap.social.ig||$('#ig').href; $('#li').href=snap.social.li||$('#li').href; $('#fb').href=snap.social.fb||$('#fb').href; }

      if(snap.blog) renderBlog(snap.blog);
      if(snap.langs_html){
        langDd.innerHTML = snap.langs_html;
        mobileLangs.innerHTML = `<div class="lang-dd" style="display:grid;grid-auto-rows:min-content" aria-hidden="false">${snap.langs_html}</div>`;
        langFlag.src = FLAG(currentLang); langCodeEl.textContent = currentLang.toUpperCase();
      }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  })();
  </script>
</header>
