{# =================== HEADER (glass + mega) =================== #}
{% set BRAND = (company[0].name if company is defined and company|length>0 and company[0].name else 'Kras-Trans') %}
{% set _lang  = (page.lang or 'pl') if page is defined else 'pl' %}
{% set _slug  = (page.slugKey or page.slug or 'home') if page is defined else 'home' %}
{% set NAV    = nav_cfg if nav_cfg is defined and nav_cfg else {} %}
{% set HREF   = hreflang if hreflang is defined else {} %}

{# języki i flagi (fallback) #}
{% set LANGS  = NAV.get('langs', ['pl','en','de','fr','it','ru','ua']) %}
{% set FLAGS  = {'pl':'🇵🇱','en':'🇬🇧','de':'🇩🇪','fr':'🇫🇷','it':'🇮🇹','ru':'🇷🇺','ua':'🇺🇦'} %}

{# link do tej samej strony w innym języku: najpierw z hreflang, inaczej /{lang}/{slug}/ #}
{% macro link_for(slugkey, lang) -%}
  {%- set map = HREF[slugkey] if HREF and (slugkey in HREF) else {} -%}
  {%- if map and (lang in map) -%}{{ map[lang] }}
  {%- else -%}
    {%- if slugkey == 'home' -%}/{{ lang }}/
    {%- else -%}/{{ lang }}/{{ slugkey }}/
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

{# pomocnicze ID z etykiety #}
{% macro slug_id(s) -%}{{ (s or 'grp')|lower|replace(' ','-')|replace('/','-') }}{%- endmacro %}

{# Źródła danych dla menu: preferuj NAV.items/panels; fallback: NAV.entries (płaska lista) #}
{% set TOP_ITEMS = NAV.get('items', []) %}
{% set PANELS_SS = NAV.get('panels', []) %}
{% set ENTRIES   = NAV.get('entries', []) %}

{# Fallback z entries: standalone (bez parent) + grupy (parent) #}
{% set STANDALONE = ENTRIES|selectattr('enabled','ne',False)|selectattr('parent','in',[None,''])|list %}
{% set WITH_PARENT= ENTRIES|selectattr('enabled','ne',False)|rejectattr('parent','in',[None,''])|list %}

<header id="header" class="site-header" role="banner">
  <div class="container navbar">
    <a class="brand" href="/{{ _lang }}/" aria-label="Strona główna">
      <img src="/assets/media/logo-firma-transportowa-kras-trans.png" alt="{{ BRAND }}" width="132" height="32" decoding="async" />
      <span class="brand__name">{{ BRAND }}</span>
    </a>

    <nav class="nav" aria-label="Główna nawigacja">
      <ul class="nav__list" role="menubar">
        {# ===== tryb 1: gotowe NAV.items (zagnieżdżone dzieci) ===== #}
        {% if TOP_ITEMS %}
          {% for item in TOP_ITEMS %}
            <li role="none">
              {% if item.children %}
                <button class="nav__btn" role="menuitem" aria-haspopup="true" aria-expanded="false"
                        data-panel="panel-{{ slug_id(item.key or item.label) }}">{{ item.label }}</button>
              {% else %}
                <a class="nav__btn" role="menuitem" href="{{ item.href or link_for(item.slugKey or item.key, _lang) }}">{{ item.label }}</a>
              {% endif %}
            </li>
          {% endfor %}
        {% else %}
        {# ===== tryb 2: płaska lista NAV.entries (grupujemy wg parent) ===== #}
          {# linki bez parenta (np. Home, Contact) #}
          {% for it in STANDALONE|sort(attribute='order') %}
            <li role="none">
              <a class="nav__btn" role="menuitem" href="{{ it.href or link_for(it.slugKey or it.key, _lang) }}">{{ it.label }}</a>
            </li>
          {% endfor %}
          {# przyciski otwierające panele (unikalne parenty) #}
          {% for grp in WITH_PARENT|groupby('parent') %}
            <li role="none">
              <button class="nav__btn" role="menuitem" aria-haspopup="true" aria-expanded="false"
                      data-panel="panel-{{ slug_id(grp.grouper) }}">{{ grp.grouper }}</button>
            </li>
          {% endfor %}
        {% endif %}
      </ul>
    </nav>

    <div class="actions">
      <a href="#quote" class="cta">{{ (strings and strings.get('hero_cta_primary')) or 'Wyceń' }}</a>

      {# języki #}
      <div class="lang" data-lang aria-expanded="false">
        <button class="icon-btn" aria-haspopup="true" aria-expanded="false" aria-controls="lang-panel" title="Języki">
          🌐
        </button>
        <div id="lang-panel" class="lang__panel" role="menu" aria-label="Wybierz język">
          <ul class="lang__list">
            {% for L in LANGS %}
              {% set hrefl = 'uk' if L == 'ua' else L %}
              <li><a role="menuitem" hreflang="{{ hrefl }}" href="{{ link_for(_slug, L) }}">{{ FLAGS.get(L,'🌍') }} {{ L|upper }}</a></li>
            {% endfor %}
          </ul>
        </div>
      </div>

      {# przełącznik motywu #}
      <button id="themeToggle" class="icon-btn" aria-label="Przełącz motyw" title="Motyw: system/dark/light">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path id="themeIcon" d="M12 3a9 9 0 100 18 7 7 0 010-18z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      {# hamburger (mobile) #}
      <button class="icon-btn hamburger" id="hamburger" aria-expanded="false" aria-controls="drawer" aria-label="Menu">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  {# ========== MEGA-PANELS (desktop) ========== #}
  <div class="panels">
    {# tryb 1: NAV.panels #}
    {% if PANELS_SS %}
      {% for grp in PANELS_SS|groupby('parent') %}
        <div class="panel" id="panel-{{ slug_id(grp.grouper) }}" hidden>
          <div class="container panel__grid">
            {% for colset in grp.list|groupby('col') %}
              <div class="panel__col">
                {% for it in colset.list|sort(attribute='order') %}
                  {% if it.type == 'promo' and it.promo_img %}
                    <a class="panel__promo" href="{{ it.href or '#' }}"><img src="{{ it.promo_img }}" alt=""></a>
                  {% else %}
                    <a class="panel__link" href="{{ it.href or link_for(it.slugKey or it.key, _lang) }}">
                      {% if it.badge %}<span class="chip">{{ it.badge }}</span>{% endif %}
                      <strong>{{ it.label }}</strong>
                    </a>
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      {# tryb 2: z NAV.entries (grupowanie po parent) #}
      {% for grp in WITH_PARENT|groupby('parent') %}
        <div class="panel" id="panel-{{ slug_id(grp.grouper) }}" hidden>
          <div class="container panel__grid">
            {% for colset in grp.list|groupby('col') %}
              <div class="panel__col">
                {% for it in colset.list|sort(attribute='order') %}
                  {% if it.promo_img %}
                    <a class="panel__promo" href="{{ it.href or '#' }}"><img src="{{ it.promo_img }}" alt=""></a>
                  {% else %}
                    <a class="panel__link" href="{{ it.href or link_for(it.slugKey or it.key, _lang) }}">
                      {% if it.badge %}<span class="chip">{{ it.badge }}</span>{% endif %}
                      <strong>{{ it.label }}</strong>
                    </a>
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
</header>

{# ========== MOBILE DRAWER ========== #}
<div class="drawer" id="drawer" hidden aria-hidden="true">
  <div class="drawer__head">
    <div class="brand"><span class="brand__logo">K</span><span class="brand__name">{{ BRAND }}</span></div>
    <button class="icon-btn" id="drawerClose" aria-label="Zamknij menu">×</button>
  </div>
  <div class="drawer__body">
    <nav aria-label="Menu mobilne">
      <ul class="drawer__list">
        {% if TOP_ITEMS %}
          {% for it in TOP_ITEMS %}
            {% if it.children %}
              <li class="acc">
                <button class="acc__btn" aria-expanded="false">{{ it.label }}</button>
                <div class="acc__panel">
                  {% for col in it.children|groupby('col') %}
                    <ul class="sublist">
                      {% for x in col.list|sort(attribute='order') %}
                        <li><a href="{{ x.href or link_for(x.slugKey or x.key, _lang) }}">{{ x.label }}</a></li>
                      {% endfor %}
                    </ul>
                  {% endfor %}
                </div>
              </li>
            {% else %}
              <li><a href="{{ it.href or link_for(it.slugKey or it.key, _lang) }}">{{ it.label }}</a></li>
            {% endif %}
          {% endfor %}
        {% else %}
          {# fallback z entries #}
          {% for it in STANDALONE|sort(attribute='order') %}
            <li><a href="{{ it.href or link_for(it.slugKey or it.key, _lang) }}">{{ it.label }}</a></li>
          {% endfor %}
          {% for grp in WITH_PARENT|groupby('parent') %}
            <li class="acc">
              <button class="acc__btn" aria-expanded="false">{{ grp.grouper }}</button>
              <div class="acc__panel">
                <ul class="sublist">
                  {% for x in grp.list|sort(attribute='order') %}
                    <li><a href="{{ x.href or link_for(x.slugKey or x.key, _lang) }}">{{ x.label }}</a></li>
                  {% endfor %}
                </ul>
              </div>
            </li>
          {% endfor %}
        {% endif %}
      </ul>
    </nav>
    <div class="drawer__langs">
      {% for L in LANGS %}
        <a hreflang="{{ 'uk' if L=='ua' else L }}" href="{{ link_for(_slug, L) }}">{{ FLAGS.get(L,'🌍') }} {{ L|upper }}</a>
      {% endfor %}
    </div>
  </div>
</div>

{# ========== BOTTOM DOCK (zawsze widoczny) ========== #}
<nav class="dock" aria-label="Skróty">
  <a href="/{{ _lang }}/"><span></span><em>{{ (strings and strings.get('dock_home')) or 'Start' }}</em></a>
  <a href="#quote"><span></span><em>{{ (strings and strings.get('hero_cta_primary')) or 'Wycena' }}</em></a>
  <button id="dockMenu"><span></span><em>{{ (strings and strings.get('dock_menu')) or 'Menu' }}</em></button>
</nav>

{# ========== JS do headera (bez zależności) ========== #}
<script>
(function(){
  // helperzy
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // ===== mega-menu
  const btns   = $$('.nav__btn[data-panel]');
  const panels = $$('.panel');

  function openPanel(id){
    panels.forEach(p => p.hidden = (p.id !== id));
    btns.forEach(b => b.setAttribute('aria-expanded', b.dataset.panel === id ? 'true' : 'false'));
    document.body.classList.toggle('mega-open', true);
  }
  function closePanels(){
    panels.forEach(p => p.hidden = true);
    btns.forEach(b => b.setAttribute('aria-expanded','false'));
    document.body.classList.remove('mega-open');
  }

  btns.forEach(b=>{
    b.addEventListener('click', (e)=>{
      const id = b.dataset.panel;
      const isOpen = b.getAttribute('aria-expanded') === 'true';
      isOpen ? closePanels() : openPanel(id);
    });
    // desktop hover
    if (matchMedia('(pointer:fine)').matches){
      b.addEventListener('mouseenter', ()=> openPanel(b.dataset.panel));
    }
  });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePanels(); });
  document.addEventListener('click', (e)=>{
    if (!e.target.closest('.nav') && !e.target.closest('.panels')) closePanels();
  });

  // ===== języki
  const langWrap = document.querySelector('[data-lang]');
  if (langWrap){
    const btn = langWrap.querySelector('button');
    const panel = $('#lang-panel');
    function toggleLang(force){
      const open = force ?? (langWrap.getAttribute('aria-expanded') !== 'true');
      langWrap.setAttribute('aria-expanded', open ? 'true' : 'false');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      panel.hidden = !open;
    }
    btn.addEventListener('click', ()=> toggleLang());
    document.addEventListener('click', (e)=>{
      if (!langWrap.contains(e.target)) toggleLang(false);
    });
  }

  // ===== motyw: system → dark → light
  const root = document.documentElement;
  const btnTheme = $('#themeToggle');
  const icon = $('#themeIcon');
  const modes = ['system','dark','light'];
  function applyTheme(m){
    if(m==='system'){ root.removeAttribute('data-theme'); }
    else{ root.setAttribute('data-theme', m); }
    localStorage.setItem('theme', m);
    icon.setAttribute('d', m==='dark'
      ? 'M12 3a9 9 0 100 18 7 7 0 010-18z'
      : 'M12 4v4m0 8v4m8-8h-4M8 12H4m10.5-5.5l-2.8 2.8m-4.4 4.4l-2.8 2.8m10 0l-2.8-2.8m-4.4-4.4L6.3 6.5');
  }
  function nextMode(cur){ return modes[(modes.indexOf(cur)+1)%modes.length]; }
  let mode = localStorage.getItem('theme') || 'system';
  applyTheme(mode);
  btnTheme && btnTheme.addEventListener('click', ()=>{
    mode = nextMode(mode); applyTheme(mode);
  });

  // ===== drawer (mobile)
  const drawer = $('#drawer');
  const hamb   = $('#hamburger');
  const close  = $('#drawerClose');
  function openDrawer(){ drawer.hidden=false; drawer.setAttribute('aria-hidden','false'); hamb.setAttribute('aria-expanded','true'); document.body.classList.add('drawer-open'); }
  function closeDrawer(){ drawer.hidden=true; drawer.setAttribute('aria-hidden','true'); hamb.setAttribute('aria-expanded','false'); document.body.classList.remove('drawer-open'); }
  hamb && hamb.addEventListener('click', ()=> drawer.hidden ? openDrawer() : closeDrawer());
  close && close.addEventListener('click', closeDrawer);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

  // akordeony w drawerze
  $$('.acc__btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const open = b.getAttribute('aria-expanded')==='true';
      b.setAttribute('aria-expanded', open ? 'false':'true');
      const p = b.nextElementSibling;
      if(p) p.hidden = open;
    });
    const p = b.nextElementSibling; if(p) p.hidden = true;
  });

  // ===== DOCK
  const dockBtn = $('#dockMenu');
  dockBtn && dockBtn.addEventListener('click', openDrawer);
})();
</script>
