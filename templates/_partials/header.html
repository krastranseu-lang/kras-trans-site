{# ===================== SAFE DEFAULTS ===================== #}
{% set BRAND  = (company[0].name if company is defined and company|length>0 and company[0].name else 'Kras-Trans') %}
{% set _lang  = (page.lang or 'pl')  if page is defined else 'pl' %}
{% set _slug  = (page.slugKey or page.slug or 'home') if page is defined else 'home' %}
{% set NAV    = (nav_cfg  if nav_cfg  is defined and nav_cfg  else {}) %}
{% set ITEMS  = NAV.get('items', []) %}
{% set HREF   = (hreflang if hreflang is defined else {}) %}
{% set PAGES  = (pages if pages is defined else []) %}
{% set STR    = (strings if strings is defined else {}) %}
{% set LANGS  = NAV.get('langs', ['pl','en','de','fr','it','ru','ua']) %}

{# emoji flagi #}
{% macro flag(l) -%}
  {%- set m = {'pl':'🇵🇱','en':'🇬🇧','de':'🇩🇪','fr':'🇫🇷','it':'🇮🇹','ru':'🇷🇺','ua':'🇺🇦'} -%}
  {{ m.get(l, '🏳️') }}
{%- endmacro %}

{# link dla slugKey (najpierw z hreflang, inaczej z Pages/SlugMap) #}
{% macro link_for(slugkey, lang) -%}
  {%- set map = HREF.get(slugkey, {}) -%}
  {%- if map and map.get(lang) -%}
    {{ map[lang] }}
  {%- else -%}
    {%- if slugkey in ['home',''] -%}
/{{ lang }}/
    {%- else -%}
      {%- set p = PAGES|selectattr('slugKey','equalto',slugkey)|selectattr('lang','equalto',lang)|first -%}
      /{{ lang }}/{{ (p and p.slug) or slugkey }}/
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

{# top-level: parent pusty, enabled=TRUE #}
{% set TOP = ITEMS
  |selectattr('enabled','ne',False)
  |selectattr('parent','in',[None,''])
  |list %}

<header id="header" class="site-header glass" role="banner">
  <div class="container navbar">
    <a class="brand" href="/{{ _lang }}/" aria-label="Strona główna">
      <img src="/assets/media/logo-firma-transportowa-kras-trans.png"
           alt="{{ BRAND }}" width="132" height="32" fetchpriority="high" />
    </a>

    <nav class="nav" aria-label="Główna nawigacja">
      <ul class="nav__list" role="menubar">
        {% for p in TOP|sort(attribute='order') %}
          {# panel id – stabilnie po key/label #}
          {% set key = (p.key or p.label or ('k' ~ loop.index))|lower|replace(' ','-') %}
          {% set children = ITEMS
              |selectattr('enabled','ne',False)
              |selectattr('parent','equalto', (p.key or p.label))
              |list %}
          <li role="none">
            {% if children|length %}
              <button class="nav__btn" role="menuitem" aria-haspopup="true"
                      aria-expanded="false" data-panel="panel-{{ key }}">
                {{ p.label }}
              </button>
            {% else %}
              {# solo link: z slugKey lub href #}
              {% set href = p.href if p.href else (p.slugKey and link_for(p.slugKey, _lang)) %}
              {% if href %}
                <a class="nav__btn" role="menuitem" href="{{ href }}">{{ p.label }}</a>
              {% endif %}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </nav>

    <div class="actions">
      <button id="themeToggle" class="icon-btn" aria-label="Przełącz motyw" title="Motyw">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path d="M12 3a9 9 0 100 18 7 7 0 010-18z" fill="currentColor"/>
        </svg>
      </button>

      <div class="lang" data-lang>
        <button class="icon-btn" aria-haspopup="true" aria-expanded="false" aria-controls="lang-panel" title="Języki">
          🌐
        </button>
        <div id="lang-panel" class="lang__panel" role="menu" aria-label="Wybierz język">
          <ul class="lang__list">
            {% for L in LANGS %}
              {% set hrefl = (L=='ua') and 'uk' or L %}
              <li>
                <a role="menuitem" hreflang="{{ hrefl }}" href="{{ link_for(_slug, L) }}">
                  {{ flag(L) }} {{ L|upper }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <a href="#quote" class="cta">{{ STR.get('hero_cta_primary','Wycena') }}</a>
    </div>
  </div>

  {# ===== Mega-panels ===== #}
  <div class="panels">
    {% for p in TOP|sort(attribute='order') %}
      {% set key = (p.key or p.label or ('k' ~ loop.index))|lower|replace(' ','-') %}
      {% set children = ITEMS
          |selectattr('enabled','ne',False)
          |selectattr('parent','equalto', (p.key or p.label))
          |list %}
      {% if children|length %}
        {% set promo = children|selectattr('type','equalto','promo')|list|first %}
        {% set links = children|rejectattr('type','equalto','promo')|list %}
        <div class="panel" id="panel-{{ key }}" hidden>
          <div class="container panel__grid">
            {# grupowanie po col; jeśli brak col – jedna kolumna #}
            {% set groups = links|sort(attribute='order')|groupby('col') %}
            {% for col, col_items in groups %}
              <div class="panel__col">
                {% for it in col_items %}
                  {% set href = it.href if it.href else (it.slugKey and link_for(it.slugKey, _lang)) %}
                  {% if href %}
                    <a class="panel__link" href="{{ href }}">
                      <strong>{{ it.label }}</strong>
                      {% if it.badge %}<span class="chip">{{ it.badge }}</span>{% endif %}
                    </a>
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}

            {% if promo %}
              <div class="panel__col panel__promo">
                {% set phref = promo.promo_href or (promo.slugKey and link_for(promo.slugKey, _lang)) %}
                <a class="promo" href="{{ phref or '#' }}">
                  {% if promo.promo_image %}
                    <img src="{{ promo.promo_image }}" alt="" loading="lazy" decoding="async"/>
                  {% endif %}
                  <div class="promo__txt">
                    <h4>{{ promo.label or 'Polecane' }}</h4>
                    {% if promo.desc %}<p>{{ promo.desc }}</p>{% endif %}
                  </div>
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</header>
